<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üöå Coimbatore Smart Bus Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="styles.css"/>
    <script src="script.js"></script>
</head>
<div>

<nav>
    <h1>üöå Coimbatore Bus Tracker</h1>
    <div class="nav-buttons" style="display: flex; align-items: center; gap: 10px;"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const navButtons = document.querySelector('.nav-buttons');
            if (isLoggedIn) {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            navButtons.innerHTML = `
                <div style="display: flex; align-items: center; position: relative;">
                <img src="${currentUser.profilePic || 'default-profile.png'}" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 10px; cursor: pointer;" onclick="openAdminPanel()">
                <button style="background: none; border: none; font-size: 24px; cursor: pointer;" onclick="toggleDropdown()">‚ãÆ</button>
                <div class="dropdown-content" id="dropdownMenu" style="display: none; position: absolute; top: 70px; right: 0; background: #333; color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); padding: 10px; z-index: 1000;">
                    <div style="text-align: center; margin-bottom: 10px;">
                    <img src="${currentUser.profilePic || 'default-profile.png'}" alt="Profile" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;">
                    <p style="margin: 0; font-weight: bold;">üë§ ${currentUser.name}</p>
                    <p style="margin: 0; font-size: 0.9rem; color: #ccc;">üìß ${currentUser.email}</p>
                    </div>
                    <button onclick="openAdminPanel()" style="display: block; width: 100%; margin-bottom: 5px;">‚öôÔ∏è Admin Panel</button>
                    <button onclick="logout()" style="display: block; width: 100%; margin-bottom: 5px;">üö™ Logout</button>
                    <button onclick="openPopup('smsNotification')" style="display: block; width: 100%; margin-bottom: 5px;">üì© SMS Notification</button>
                    <button onclick="showModal()" style="display: block; width: 100%; margin-bottom: 5px;">üöå Bus Info</button>
                    <button onclick="openPopup('favoritesModal')" style="display: block; width: 100%; margin-bottom: 5px;">‚≠ê Favorites</button>
                    <button onclick="openPopup('notificationsModal')" style="display: block; width: 100%; margin-bottom: 5px;">üîî Notifications</button>
                    <button onclick="openPopup('settingsModal')" style="display: block; width: 100%;">‚öôÔ∏è Settings</button>
                </div>
                </div>
            `;
            } else {
            navButtons.innerHTML = `
                <div style="display: flex; align-items: center; position: relative;">
                <img src="default-profile.png" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 10px; cursor: pointer;" onclick="openPopup('loginModal')">
                <button style="background: none; border: none; font-size: 24px; cursor: pointer;" onclick="toggleDropdown()">‚ãÆ</button>
                <div class="dropdown-content" id="dropdownMenu" style="display: none; position: absolute; top: 70px; right: 0; background: #333; color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); padding: 10px; z-index: 1000;">
                    <div style="text-align: center; margin-bottom: 10px;">
                    <img src="default-profile.png" alt="Profile" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;">
                    <p style="margin: 0; font-weight: bold;">üë§ Guest</p>
                    <p style="margin: 0; font-size: 0.9rem; color: #ccc;">üîí Please log in</p>
                    </div>
                    <button onclick="openPopup('loginModal')" style="display: block; width: 100%; margin-bottom: 5px;">üîë Login</button>
                    <button onclick="openPopup('registerModal')" style="display: block; width: 100%; margin-bottom: 5px;">üìù Register</button>
                    <button onclick="showModal()" style="display: block; width: 100%; margin-bottom: 5px;">üöå Bus Info</button>
                    <button onclick="openPopup('favoritesModal')" style="display: block; width: 100%; margin-bottom: 5px;">‚≠ê Favorites</button>
                    <button onclick="openPopup('notificationsModal')" style="display: block; width: 100%; margin-bottom: 5px;">üîî Notifications</button>
                    <button onclick="openPopup('settingsModal')" style="display: block; width: 100%;">‚öôÔ∏è Settings</button>
                </div>
                </div>
            `;
            const loginButton = document.getElementById('loginButton');

            }
        });

        function toggleDropdown() {
            const dropdownMenu = document.getElementById('dropdownMenu');
            dropdownMenu.style.display = dropdownMenu.style.display === 'none' || dropdownMenu.style.display === '' ? 'block' : 'none';
        }

        document.addEventListener('click', (event) => {
            const dropdownMenu = document.getElementById('dropdownMenu');
            if (dropdownMenu && !dropdownMenu.contains(event.target) && !event.target.closest('button')) {
                dropdownMenu.style.display = 'none';
            }
        });
    </script>
</nav>
<div id="filterSection" style="display: none;">
    <div class="filter-container" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between; padding: 1rem; background: var(--card-bg); border-radius: 10px; box-shadow: var(--neon-glow);">
      <!-- Location Tracking -->
      <div class="location-tracking-container" style="flex: 1; text-align: center;">
        <button onclick="trackLocation()" style="padding: 10px 20px; border-radius: 8px; background: var(--accent-color); color: #fff; font-weight: bold; cursor: pointer; box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">üìç Locate Me</button>
        <p id="location-status-1" style="margin-top: 10px; color: var(--text-color); font-size: 0.9rem;">Location status will appear here.</p>
      </div>
  
      <!-- Destination Filter -->
      <div class="destination-filter-container" style="flex: 1; text-align: center;">
        <label for="destination-filter" style="color: var(--text-color); font-weight: bold; margin-right: 10px;">Filter by Destination:</label>
        <select id="destination-filter" onchange="filterByDestination(this.value)" style="padding: 10px; border-radius: 8px; background: var(--card-bg); color: var(--text-color); border: 1px solid var(--accent-color); box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">
          <option value="">All Destinations</option>
        </select>
      </div>
  
      <!-- Voice Search -->
      <div class="voice-search-container" style="flex: 1; text-align: center;">
        <button onclick="startVoiceSearch()" style="padding: 10px 20px; border-radius: 8px; background: var(--primary-color); color: #fff; font-weight: bold; cursor: pointer; box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">üé§ Voice Search</button>
        <p id="voice-search-status" style="margin-top: 10px; color: var(--text-color); font-size: 0.9rem;">Speak to search for a destination.</p>
      </div>
    </div>
  </div>
  
    <script>
        function startVoiceSearch() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) {
                alert('Please log in to use the voice search feature.');
                return;
            }

            if (!('webkitSpeechRecognition' in window)) {
                alert('Voice search is not supported in this browser.');
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                document.getElementById('voice-search-status').textContent = 'Listening...';
                const utterance = new SpeechSynthesisUtterance('I am listening. Please say your destination.');
                window.speechSynthesis.speak(utterance);
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('voice-search-status').textContent = `You said: "${transcript}"`;
                const utterance = new SpeechSynthesisUtterance(`You said ${transcript}. Searching for buses.`);
                window.speechSynthesis.speak(utterance);

                const filteredBuses = busData.filter(bus => bus.destination.toLowerCase().includes(transcript.toLowerCase()));
                if (filteredBuses.length > 0) {
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.marginTop = '10px';

                    const headerRow = document.createElement('tr');
                    headerRow.innerHTML = `
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Bus ID</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Start</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Destination</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Timings</th>
                    `;
                    table.appendChild(headerRow);

                    filteredBuses.forEach(bus => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="border: 1px solid #ccc; padding: 8px;">${bus.id}</td>
                            <td style="border: 1px solid #ccc; padding: 8px;">${bus.start}</td>
                            <td style="border: 1px solid #ccc; padding: 8px;">${bus.destination}</td>
                            <td style="border: 1px solid #ccc; padding: 8px;">${bus.time}</td>
                        `;
                        table.appendChild(row);
                    });

                    const voiceSearchStatus = document.getElementById('voice-search-status');
                    voiceSearchStatus.textContent = '';
                    voiceSearchStatus.appendChild(table);

                    const summary = `Found ${filteredBuses.length} buses.`;
                    const utterance = new SpeechSynthesisUtterance(summary);
                    window.speechSynthesis.speak(utterance);

                    // Show buses on the map
                    loadBuses(filteredBuses);
                } else {
                    const utterance = new SpeechSynthesisUtterance('No buses found for the given destination.');
                    window.speechSynthesis.speak(utterance);
                    document.getElementById('voice-search-status').textContent = 'No buses found.';
                }
            };

            recognition.onerror = (event) => {
                document.getElementById('voice-search-status').textContent = 'Error occurred during voice recognition.';
                const utterance = new SpeechSynthesisUtterance('An error occurred during voice recognition. Please try again.');
                window.speechSynthesis.speak(utterance);
                console.error('Voice recognition error:', event.error);
            };

            recognition.start();
        }
    </script>
</div>
<div id="loggedOutOnlyContent" style="display: none;">
    <div id="dailyFeed" style="margin-top: 20px; padding: 1rem; background: var(--card-bg); border-radius: 10px; box-shadow: var(--neon-glow);">
        <h2 style="color: var(--primary-color);">üå§Ô∏è Daily Feed & Weather</h2>
        <p id="weatherInfo" style="color: var(--text-color);">Fetching weather information...</p>
        <p id="dailyTips" style="color: var(--text-color); margin-top: 10px;">Loading tip of the day...</p>
    </div>

    <div id="feedbackSection" style="margin-top: 20px; padding: 1.5rem; background: var(--card-bg); border-radius: 12px; box-shadow: var(--neon-glow);">
        <h2 style="color: var(--primary-color); text-align: center; text-shadow: 0 0 10px var(--primary-color);">üìù Share Your Feedback</h2>
        <form onsubmit="submitFeedback(event)" style="display: flex; flex-direction: column; gap: 1.5rem; margin-top: 1rem;">
            <!-- form elements... -->
        </form>
        <p id="feedbackMessage" style="color: lime; display: none; margin-top: 15px; text-align: center; font-size: 1rem;">Thank you for your valuable feedback! üòä</p>
        <div id="feedbackList" style="margin-top: 20px; padding: 1rem; background: var(--card-bg); border-radius: 10px; box-shadow: var(--neon-glow);">
            <h3 style="color: var(--primary-color); text-align: center;">üìã Feedback History</h3>
            <ul id="feedbackHistory" style="list-style-type: none; padding: 0; color: var(--text-color);">
                <!-- Feedback history will be dynamically loaded here -->
            </ul>
        </div>
    </div>
</div>


<script>
    const feedbackKey = 'userFeedback';

    function submitFeedback(event) {
        event.preventDefault();
        const feedbackName = document.getElementById('feedbackName').value.trim();
        const feedbackInput = document.getElementById('feedbackInput').value.trim();
        const rating = document.querySelector('input[name="rating"]:checked').value;
        const feedbackMessage = document.getElementById('feedbackMessage');

        const feedback = {
            name: feedbackName,
            text: feedbackInput,
            rating: rating,
            timestamp: new Date().toLocaleString()
        };

        const feedbackList = JSON.parse(localStorage.getItem(feedbackKey)) || [];
        feedbackList.push(feedback);
        localStorage.setItem(feedbackKey, JSON.stringify(feedbackList));

        feedbackMessage.style.display = 'block';
        document.getElementById('feedbackName').value = '';
        document.getElementById('feedbackInput').value = '';
        document.querySelector('input[name="rating"]:checked').checked = false;

        setTimeout(() => {
            feedbackMessage.style.display = 'none';
        }, 3000);

        loadFeedbackHistory();
    }

    function loadFeedbackHistory() {
        const feedbackList = JSON.parse(localStorage.getItem(feedbackKey)) || [];
        const feedbackHistory = document.getElementById('feedbackHistory');
        feedbackHistory.innerHTML = '';

        feedbackList.forEach(feedback => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${feedback.timestamp}</strong>: <em>${feedback.name}</em> said "${feedback.text}" (Rating: ${feedback.rating}/5)`;
            feedbackHistory.appendChild(li);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadFeedbackHistory();
    });
</script>


<div id="map" style="height: 500px; border: 2px solid #ccc; border-radius: 10px; margin-top: 10px;"></div>

<div class="modal" id="busModal" style="width: 90%; max-width: 800px; background: var(--modal-bg); color: var(--text-color); padding: 1.5rem; border-radius: 12px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);">
    <button class="close-btn" onclick="hideModal()" style="position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #ff0059, #ff4081); color: #fff; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 16px; cursor: pointer; box-shadow: 0 0 15px rgba(255, 0, 89, 0.7);">√ó</button>
    <h2 style="text-align: center; color: var(--primary-color); text-shadow: var(--neon-glow);">Bus Information</h2>
    <div style="overflow-x: auto; max-height: 70vh; margin-top: 1rem;">
        <table style="width: 100%; border-collapse: collapse; background-color: #222; border: 2px solid var(--accent-color); box-shadow: var(--neon-glow); color: var(--text-color);">
            <thead style="background-color: #333; color: var(--primary-color);">
                <tr>
                    <th style="padding: 14px; border-bottom: 1px solid #444; text-align: left;">ID</th>
                    <th style="padding: 14px; border-bottom: 1px solid #444; text-align: left;">Start</th>
                    <th style="padding: 14px; border-bottom: 1px solid #444; text-align: left;">Destination</th>
                    <th style="padding: 14px; border-bottom: 1px solid #444; text-align: left;">Timings</th>
                    <th style="padding: 14px; border-bottom: 1px solid #444; text-align: left;">Action</th>
                </tr>
            </thead>
            <tbody id="busTable"></tbody>
        </table>
    </div>
</div>

<div class="modal" id="smsNotification">
    <button class="close-btn" onclick="closePopup('smsNotification')">√ó</button>
    <h2>SMS Notification</h2>
    <form onsubmit="enableSmsNotification(event)">
        <input type="tel" id="phoneNumber" required placeholder="Enter your phone number" />
        <button type="submit">Enable Alerts</button>
    </form>
</div>

<div class="modal" id="historyModal">
    <button class="close-btn" onclick="closePopup('historyModal')">√ó</button>
    <h2>Notification History</h2>
    <ul id="historyList" style="list-style-type: none;"></ul>
</div>

<div class="modal" id="loginModal" style="background: linear-gradient(135deg, #1e1e1e, #2a2a2a); color: #fff; padding: 2rem; border-radius: 15px; box-shadow: 0 0 25px rgba(0, 255, 255, 0.7);">
    <button class="close-btn" onclick="closePopup('loginModal')" style="position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #ff0059, #ff4081); color: #fff; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 18px; cursor: pointer; box-shadow: 0 0 20px rgba(255, 0, 89, 0.8);">√ó</button>
    <h2 style="text-align: center; color: var(--primary-color); text-shadow: 0 0 15px var(--primary-color); font-size: 1.8rem;">Login</h2>
    <form onsubmit="handleLogin(event)" style="margin-top: 1.5rem;">
        <div class="input-container" style="margin-bottom: 1.5rem;">
            <input type="text" id="loginEmail" required placeholder="Email or Phone" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #222; color: #fff; border: 1px solid #555; font-size: 1rem;" />
        </div>
        <div class="input-container" style="margin-bottom: 1.5rem;">
            <input type="password" id="loginPassword" required placeholder="Password" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #222; color: #fff; border: 1px solid #555; font-size: 1rem;" />
        </div>
        <label style="display: flex; align-items: center; gap: 10px; color: #ccc; font-size: 0.9rem; margin-bottom: 1rem;">
            <input type="checkbox" id="showLoginPasswordToggle" onclick="toggleLoginPasswordVisibility()" />
            Show Password
        </label>
        <button type="submit" id="loginButton" style="width: 100%; padding: 12px; border-radius: 10px; background-color: var(--accent-color); color: #fff; font-weight: bold; font-size: 1rem; cursor: pointer; box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);">Login</button>
    </form>
    <p id="loginError" style="color: red; display: none; margin-top: 1.5rem; text-align: center; font-size: 0.9rem;">Invalid email or password. Please try again.</p>
</div>

<div class="modal" id="registerModal" style="background: linear-gradient(135deg, #1e1e1e, #2a2a2a); color: #fff; padding: 2rem; border-radius: 15px; box-shadow: 0 0 25px rgba(0, 255, 255, 0.7);">
    <button class="close-btn" onclick="closePopup('registerModal')" style="position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #ff0059, #ff4081); color: #fff; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 18px; cursor: pointer; box-shadow: 0 0 20px rgba(255, 0, 89, 0.8);">√ó</button>
    <h2 style="text-align: center; color: var(--primary-color); text-shadow: 0 0 15px var(--primary-color); font-size: 1.8rem;">Register</h2>
    <form id="registerForm" onsubmit="handleRegister(event)" style="margin-top: 1.5rem;">
        <input type="text" id="registerName" required placeholder="Name" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #222; color: #fff; border: 1px solid #555; margin-bottom: 1.5rem; font-size: 1rem;" />
        <input type="text" id="registerPhone" required placeholder="Phone" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #222; color: #fff; border: 1px solid #555; margin-bottom: 1.5rem; font-size: 1rem;" />
        <input type="email" id="registerEmail" required placeholder="Email" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #222; color: #fff; border: 1px solid #555; margin-bottom: 1.5rem; font-size: 1rem;" />
        <div class="input-container" style="margin-bottom: 1.5rem;">
            <input type="password" id="registerPassword" required placeholder="Password" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #222; color: #fff; border: 1px solid #555; font-size: 1rem;" />
            <label style="display: flex; align-items: center; gap: 10px; color: #ccc; font-size: 0.9rem; margin-top: 10px;">
                <input type="checkbox" id="showRegisterPasswordToggle" onclick="toggleRegisterPasswordVisibility()" />
                Show Password
            </label>
        </div>
        <div class="input-container" style="margin-bottom: 1.5rem;">
            <input type="password" id="registerConfirmPassword" required placeholder="Confirm Password" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #222; color: #fff; border: 1px solid #555; font-size: 1rem;" />
        </div>
        <button type="button" onclick="sendVerificationCode()" style="width: 100%; padding: 12px; border-radius: 10px; background-color: var(--primary-color); color: #000; font-weight: bold; font-size: 1rem; cursor: pointer; margin-bottom: 1.5rem; box-shadow: 0 0 15px rgba(255, 0, 89, 0.7);">Send Verification Code</button>
        <input type="text" id="verificationCode" required placeholder="Enter Verification Code" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #222; color: #fff; border: 1px solid #555; margin-bottom: 1.5rem; font-size: 1rem;" />
        <button type="submit" id="registerButton" style="width: 100%; padding: 12px; border-radius: 10px; background-color: var(--accent-color); color: #fff; font-weight: bold; font-size: 1rem; cursor: pointer; box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);">Register</button>
        <p id="registerMsg" style="color: lime; display: none; margin-top: 1.5rem; text-align: center; font-size: 0.9rem; width: 100%;">Registration successful! Please log in.</p>
    </form>
    <p id="registerError" style="color: red; display: none; margin-top: 1.5rem; text-align: center; font-size: 0.9rem;">Registration failed. Please try again.</p>
</div>
<!-- Admin Panel Modal -->
<div class="modal" id="adminPanelModal" style="background: linear-gradient(135deg, #1e1e1e, #2a2a2a); color: #fff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.5); width: 90%; max-width: 700px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);">
    <button class="close-btn" onclick="closePopup('adminPanelModal')" style="position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #ff0059, #ff4081); color: #fff; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 16px; cursor: pointer; box-shadow: 0 0 15px rgba(255, 0, 89, 0.7);">√ó</button>
    <h2 style="text-align: center; color: var(--primary-color); text-shadow: 0 0 10px var(--primary-color);">Admin Panel</h2>

    <div id="adminUserList" style="max-height: 400px; overflow-y: auto; margin-top: 1rem;">
        <!-- Dynamic user list injected by JS -->
    </div>

    <p id="adminMsg" style="color: lime; display: none; margin-top: 1rem; text-align: center;">User updated successfully!</p>
</div>

<style>
</style>

<script>
function openAdminPanel() {
    const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
    const userList = document.getElementById('adminUserList');
    userList.innerHTML = ''; // Clear previous list

    users.forEach((user, index) => {
        const userCard = document.createElement('div');
        userCard.style.cssText = 'background: #2e2e2e; margin-bottom: 1rem; padding: 1rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,255,255,0.3);';

        userCard.innerHTML = `
            <strong style="color: var(--primary-color);">User ${index + 1}</strong><br>
            <div class="profile-pic-container">
                <img src="${user.profilePic || 'default-profile.png'}" alt="Profile Picture" id="profilePic-${index}">
                <button class="edit-button" onclick="document.getElementById('fileInput-${index}').click()" style="background: transparent; box-shadow: none;">‚úé</button>
                <input type="file" id="fileInput-${index}" accept="image/*" style="display: none;" onchange="updateProfilePic(event, ${index})">
            </div>
            <label style="display:block;margin:5px 0;color:#aaa;">Name:
                <input type="text" value="${user.name}" data-index="${index}" data-field="name" class="adminInput" style="width: 100%; padding: 5px; margin-top: 5px; background: #111; color: #fff; border: 1px solid #555; border-radius: 6px;">
            </label>
            <label style="display:block;margin:5px 0;color:#aaa;">Phone:
                <input type="text" value="${user.phone}" data-index="${index}" data-field="phone" class="adminInput" style="width: 100%; padding: 5px; margin-top: 5px; background: #111; color: #fff; border: 1px solid #555; border-radius: 6px;">
            </label>
            <label style="display:block;margin:5px 0;color:#aaa;">Email:
                <input type="email" value="${user.email}" disabled style="width: 100%; padding: 5px; margin-top: 5px; background: #333; color: #ccc; border: none; border-radius: 6px;">
            </label>
            <label style="display: flex; align-items: center; gap: 5px; color: #aaa; margin-top: 10px;">
                <input type="checkbox" ${user.smsAlerts ? 'checked' : ''} data-index="${index}" data-field="smsAlerts" class="adminCheckbox"> Enable SMS Alerts
            </label>
            <button onclick="saveUserUpdate(${index})" style="margin-top: 10px; background-color: var(--accent-color); color: #fff; padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">Save</button>
        `;

        userList.appendChild(userCard);
    });

    openPopup('adminPanelModal');
}

function updateProfilePic(event, index) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
            users[index].profilePic = e.target.result;
            localStorage.setItem('registeredUsers', JSON.stringify(users));

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser?.email === users[index].email) {
                localStorage.setItem('currentUser', JSON.stringify(users[index]));
            }

            document.getElementById(`profilePic-${index}`).src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function saveUserUpdate(index) {
    const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];

    const nameInput = document.querySelector(`.adminInput[data-index="${index}"][data-field="name"]`);
    const phoneInput = document.querySelector(`.adminInput[data-index="${index}"][data-field="phone"]`);
    const smsCheckbox = document.querySelector(`.adminCheckbox[data-index="${index}"][data-field="smsAlerts"]`);

    if (nameInput && phoneInput && smsCheckbox) {
        users[index].name = nameInput.value.trim();
        users[index].phone = phoneInput.value.trim();
        users[index].smsAlerts = smsCheckbox.checked;

        localStorage.setItem('registeredUsers', JSON.stringify(users));

        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser?.email === users[index].email) {
            localStorage.setItem('currentUser', JSON.stringify(users[index]));
        }

        const msg = document.getElementById('adminMsg');
        msg.style.display = 'block';
        setTimeout(() => {
            msg.style.display = 'none';
            closePopup('adminPanelModal'); // Close the modal after saving
        }, 1500);
    }
}
</script>

    
<div class="modal" id="favoritesModal">
    <button class="close-btn" onclick="closePopup('favoritesModal')">√ó</button>
    <h2>Favorites</h2>
    <ul id="favoritesList"></ul>
    <form onsubmit="addFavorite(event)">
        <input type="text" id="newFavorite" required placeholder="Add Bus ID" />
        <button type="submit">Add</button>
    </form>
</div>

<!-- Notifications Modal -->
<div class="modal" id="notificationsModal">
    <button class="close-btn" onclick="closePopup('notificationsModal')">√ó</button>
    <h2>Notifications</h2>
    <ul id="notificationsList"></ul>
    <button onclick="refreshNotifications()">Refresh</button>
</div>

<!-- Enhanced Settings Modal -->
<div class="modal" id="settingsModal">
    <button class="close-btn" onclick="closePopup('settingsModal')">√ó</button>
    <h2>‚öôÔ∏è Settings</h2>
    <div class="setting-option">
        <label>
            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()" />
            üåô Dark Mode
        </label>
    </div>

    <div class="setting-option">
        <label>
            üåê Language:
            <select id="languageSelect" onchange="changeLanguage()">
                <option value="en">English</option>
                <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
                <option value="es">Espa√±ol (Spanish)</option>
                <option value="fr">Fran√ßais (French)</option>
            </select>
        </label>
    </div>

    <div class="setting-option">
        <label>
            <input type="checkbox" id="notificationsToggle" onchange="toggleNotifications()" />
            üîî Enable Notifications
        </label>
    </div>

    <div class="setting-option">
        <label>
            <input type="checkbox" id="smsAlertToggle" onchange="toggleSmsAlerts()" />
            üì≤ SMS Alerts for Favorite Routes
        </label>
    </div>

    <div class="setting-option">
        <label>
            <input type="checkbox" id="voiceToggle" onchange="toggleVoiceAnnouncements()" />
            üîä Enable Voice Announcements
        </label>
    </div>

    <div class="setting-option">
        <label>
            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()" />
            üîÑ Auto-Refresh Bus Data
        </label>
    </div>

    <div class="setting-option">
        <label>
            <input type="checkbox" id="locationTrackingToggle" onchange="toggleLocationTracking()" />
            üìç Enable Location Tracking
        </label>
    </div>

    <div class="setting-option">
        <button class="reset-btn" onclick="resetSettings()">‚ôªÔ∏è Reset to Default</button>
    </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const busData = [
    { id: '257', lat: 11.0183, lon: 76.9748, time: '6:30 AM, 8:00 AM, 10:30 AM', start: 'Ondipudur', destination: 'Gandhipuram' },
    { id: '70', lat: 11.0075, lon: 76.9663, time: '7:00 AM, 9:15 AM, 11:45 AM', start: 'Peelamedu', destination: 'Ukkadam' },
    { id: 'S9', lat: 11.0281, lon: 76.9422, time: '6:45 AM, 9:00 AM, 12:30 PM', start: 'Saibaba Colony', destination: 'Gandhipuram' },
    { id: '33C', lat: 11.0125, lon: 76.9600, time: '7:15 AM, 9:45 AM, 1:00 PM', start: 'Kovaipudur', destination: 'Town Hall' },
    { id: '20', lat: 11.0110, lon: 76.9432, time: '6:00 AM, 8:30 AM, 11:00 AM', start: 'Gandhipuram', destination: 'Peelamedu' },
    { id: '6A', lat: 11.0020, lon: 76.9780, time: '7:30 AM, 10:00 AM, 12:30 PM', start: 'Ukkadam', destination: 'RS Puram' },
    { id: '3', lat: 11.0340, lon: 76.9542, time: '6:15 AM, 8:45 AM, 11:15 AM', start: 'Ukkadam', destination: 'Saibaba Colony' },
    { id: '12B', lat: 11.0222, lon: 76.9684, time: '7:00 AM, 9:30 AM, 12:00 PM', start: 'Town Hall', destination: 'Singanallur' },
    { id: '48', lat: 11.0303, lon: 76.9811, time: '6:50 AM, 9:20 AM, 11:50 AM', start: 'Gandhipuram', destination: 'Sundarapuram' },
    { id: '15C', lat: 11.0266, lon: 76.9877, time: '7:10 AM, 9:40 AM, 12:10 PM', start: 'Gandhipuram', destination: 'Ondipudur' },
    { id: '25', lat: 11.0350, lon: 76.9500, time: '6:20 AM, 8:50 AM, 11:20 AM', start: 'Gandhipuram', destination: 'Ganapathy' },
    { id: '10A', lat: 11.0400, lon: 76.9600, time: '7:40 AM, 10:10 AM, 12:40 PM', start: 'Gandhipuram', destination: 'Thudiyalur' },
    { id: '50', lat: 11.0450, lon: 76.9700, time: '6:10 AM, 8:40 AM, 11:10 AM', start: 'Gandhipuram', destination: 'Saravanampatti' },
    { id: '18', lat: 11.0500, lon: 76.9800, time: '7:20 AM, 9:50 AM, 12:20 PM', start: 'Ukkadam', destination: 'Kavundampalayam' },
    { id: '7C', lat: 11.0550, lon: 76.9900, time: '6:35 AM, 9:05 AM, 11:35 AM', start: 'Town Hall', destination: 'Vadavalli' },
    { id: '22B', lat: 11.0600, lon: 77.0000, time: '7:05 AM, 9:35 AM, 12:05 PM', start: 'Ukkadam', destination: 'Perur' },
    { id: '9', lat: 11.0650, lon: 77.0100, time: '6:25 AM, 8:55 AM, 11:25 AM', start: 'Gandhipuram', destination: 'Kuniamuthur' },
    { id: '16A', lat: 11.0700, lon: 77.0200, time: '7:15 AM, 9:45 AM, 12:15 PM', start: 'Ukkadam', destination: 'Singanallur' },
    { id: '5', lat: 11.0750, lon: 77.0300, time: '6:45 AM, 9:15 AM, 11:45 AM', start: 'Town Hall', destination: 'Sulur' },
    { id: '14', lat: 11.0800, lon: 77.0400, time: '7:25 AM, 9:55 AM, 12:25 PM', start: 'Gandhipuram', destination: 'Kaniyur' },
    { id: '102', lat: 10.9300, lon: 76.9650, time: '6:00 AM, 8:45 AM, 1:00 PM', start: 'Pollachi', destination: 'Kinathukidavu' },
    { id: '103A', lat: 10.9900, lon: 76.9500, time: '7:30 AM, 10:00 AM, 3:00 PM', start: 'Gandhipuram', destination: 'Kinathukidavu' },
    { id: '104B', lat: 11.0000, lon: 76.9400, time: '8:00 AM, 12:00 PM, 5:30 PM', start: 'Ukkadam', destination: 'Kinathukidavu' },
    { id: '105C', lat: 11.0150, lon: 76.9650, time: '9:00 AM, 1:30 PM, 6:30 PM', start: 'Town Hall', destination: 'Kinathukidavu' }
];
let simulationData = [];
let simulationInterval = null;
let busMarkers = {};

function initMap() {
  map = L.map('map').setView([11.0168, 76.9558], 12); // Coimbatore center

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  loadBuses(busData);
}

function loadBuses(data) {
  data.forEach(bus => {
    const position = [bus.lat, bus.lon];
    if (!busMarkers[bus.id]) {
      const marker = L.marker(position)
        .addTo(map)
        .bindPopup(`<strong>Bus ${bus.id}</strong><br>${bus.start} ‚Üí ${bus.destination}<br>Timings: ${bus.time}`);
      busMarkers[bus.id] = marker;
    } else {
      busMarkers[bus.id].setLatLng(position);
    }
  });
}

function startSimulation() {
  if (simulationInterval) {
    alert("Simulation is already running!");
    return;
  }

  simulationData = JSON.parse(JSON.stringify(busData)); // Copy current bus data

  simulationInterval = setInterval(() => {
    simulationData.forEach(bus => {
      const latShift = (Math.random() - 0.5) * 0.001;
      const lonShift = (Math.random() - 0.5) * 0.001;
      bus.lat += latShift;
      bus.lon += lonShift;
    });

    loadBuses(simulationData);
  }, 2000); // update every 2 seconds

  alert("Simulation started!");
}

function stopSimulation() {
  if (!simulationInterval) {
    alert("No simulation is running!");
    return;
  }

  clearInterval(simulationInterval);
  simulationInterval = null;
  alert("Simulation stopped!");
}

function resetSimulation() {
  if (simulationInterval) {
    clearInterval(simulationInterval);
    simulationInterval = null;
  }

  simulationData = JSON.parse(JSON.stringify(initialBusData));
  loadBuses(simulationData);
  alert("Simulation reset!");
}

// Call initMap() on window load or after DOM is ready
window.onload = initMap;

const initialBusData = JSON.parse(JSON.stringify(busData));
const map = L.map('map').setView([11.0168, 76.9558], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let markers = [];

// Ensure loadBuses function is defined and used consistently

function showModal() { 
    document.getElementById('busModal').classList.add('show'); 
    populateTable(); // Ensure table is populated when modal is shown
    logEvent('Opened Bus Info Modal');
}
function hideModal() { 
    document.getElementById('busModal').classList.remove('show'); 
    logEvent('Closed Bus Info Modal');
}
function showSms() { 
    document.getElementById('smsNotification').classList.add('show'); 
    logEvent('Opened SMS Notification Modal');
}
function showHistory() { 
    loadHistory(); 
    document.getElementById('historyModal').classList.add('show'); 
    logEvent('Opened Notification History Modal');
}
function closePopup(id) { 
    document.getElementById(id).classList.remove('show'); 
    logEvent(`Closed Modal with ID: ${id}`);
}
function populateTable(filteredBuses = busData) {
    const table = document.getElementById('busTable');
    table.innerHTML = ''; // Clear existing rows

    if (filteredBuses.length === 0) {
        table.innerHTML = '<tr><td colspan="5">No buses found</td></tr>';
    } else {
        const busesByDestination = filteredBuses.reduce((acc, bus) => {
            if (!acc[bus.destination]) {
                acc[bus.destination] = [];
            }
            acc[bus.destination].push(bus);
            return acc;
        }, {});

        Object.keys(busesByDestination).forEach(destination => {
            const destinationRow = `<tr><td colspan="5" style="font-weight: bold; text-align: center; ">${destination}</td></tr>`;
            table.innerHTML += destinationRow;

            busesByDestination[destination].forEach(bus => {
                const row = `
                    <tr>
                        <td>${bus.id}</td>
                        <td>${bus.start}</td>
                        <td>${bus.destination}</td>
                        <td>${bus.time}</td>
                        <td><button onclick="addTracking('${bus.id}')">Track</button></td>
                    </tr>`;
                table.innerHTML += row;
            });
        });
    }

    const destFilter = document.getElementById('destination-filter');
    const uniqueDestinations = [...new Set(busData.map(b => b.destination))];
    destFilter.innerHTML = '<option value="">All</option>'; // Clear existing options
    uniqueDestinations.forEach(d => {
        if (!Array.from(destFilter.options).some(option => option.value === d)) {
            destFilter.innerHTML += `<option value="${d}">${d}</option>`;
        }
    });
    logEvent('Filtered destinations and updated dropdown to include "All" option');
}

function addTracking(busId) {
    const bus = busData.find(b => b.id === busId);
    if (!bus) {
        alert(`Bus with ID ${busId} not found.`);
        logEvent(`Tracking failed: Bus ID ${busId} not found`);
        return;
    }

    const marker = L.marker([bus.lat, bus.lon], { icon: L.icon({
        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        shadowSize: [41, 41]
    }) }).addTo(map).bindPopup(`üöå <strong>Tracking Bus ${bus.id}</strong><br><strong>Route:</strong> ${bus.start} ‚Üí ${bus.destination}<br><strong>Timings:</strong> ${bus.time}`).openPopup();

    map.setView([bus.lat, bus.lon], 14);
    logEvent(`Started tracking Bus ID: ${busId}`);
}

function filterByDestination(dest) {
    if (!dest) return;
    document.getElementById('busModal').classList.add('show');
    const filtered = busData.filter(bus => bus.destination === dest);
    populateTable(filtered);
    logEvent(`Filtered buses by destination: ${dest}`);
}


function populateDropdown() {
    const destinations = [...new Set(busData.map(b => b.destination))].sort();
    const dropdown = document.getElementById('destination-filter');
    dropdown.innerHTML = '<option value="">All</option>'; // Clear existing options
    destinations.forEach(dest => {
        if (!Array.from(dropdown.options).some(option => option.value === dest)) {
            const option = document.createElement('option');
            option.value = dest;
            option.textContent = dest;
            dropdown.appendChild(option);
        }
    });
    logEvent('Populated destination dropdown');
}

const locationTrackingControl = L.control({ position: 'bottomright' });
locationTrackingControl.onAdd = function () {
    const div = L.DomUtil.create('div', 'location-tracking-container');
    div.innerHTML = ``;
    L.DomEvent.disableClickPropagation(div);
    return div;
};
locationTrackingControl.addTo(map);

const dropdown = L.control({ position: 'topright' });
dropdown.onAdd = function () {
    const div = L.DomUtil.create('div', 'destination-dropdown');
    div.innerHTML = ``;
    return div;
};
dropdown.addTo(map);
populateDropdown();

function enableSmsNotification(e) {
    e.preventDefault();
    const phone = document.getElementById('phoneNumber').value;
    if (!phone) return alert('Enter a valid phone number!');
    const msg = `Alerts enabled for ${phone}`;
    alert(msg);
    saveToHistory(msg);
    closePopup('smsNotification');
    logEvent(`Enabled SMS Notification for Phone: ${phone}`);
}

const historyKey = 'busTrackerHistory';
function saveToHistory(entry) {
    const history = JSON.parse(localStorage.getItem(historyKey)) || [];
    history.push({ entry, timestamp: new Date().toLocaleString() });
    localStorage.setItem(historyKey, JSON.stringify(history));
    logEvent(`Saved to History: ${entry}`);
}

function loadHistory() {
    const history = JSON.parse(localStorage.getItem(historyKey)) || [];
    const list = document.getElementById('historyList');
    list.innerHTML = '';
    history.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.timestamp} - ${item.entry}`;
        list.appendChild(li);
    });
    logEvent('Loaded Notification History');
}
function startSimulation() {
    const selectedDestination = document.getElementById('destination-filter').value;
    if (!selectedDestination) {
        alert("Please select a destination to start the simulation!");
        return;
    }

    if (simulationInterval) {
        alert("Simulation is already running!");
        return;
    }

    simulationData = JSON.parse(JSON.stringify(busData)); // Copy current bus data

    simulationInterval = setInterval(() => {
        simulationData.forEach(bus => {
            if (bus.destination === selectedDestination) { // Only simulate for buses with the selected destination
                const latShift = (Math.random() - 0.005) * 0.01; // Larger shift for more noticeable movement
                const lonShift = (Math.random() - 0.005) * 0.01;
                bus.lat += latShift;
                bus.lon += lonShift;
            }
        });

        loadBuses(simulationData);
    }, 1000); // update every 1 second for faster simulation

    alert(`Simulation started for buses heading to ${selectedDestination}!`);
}

function stopSimulation() {
    if (!simulationInterval) {
        alert("No simulation is running!");
        return;
    }

    clearInterval(simulationInterval);
    simulationInterval = null;
    alert("Simulation stopped!");
}

function resetSimulation() {
    if (simulationInterval) {
        clearInterval(simulationInterval);
        simulationInterval = null;
    }

    simulationData = JSON.parse(JSON.stringify(busData)); // Reset to original bus data
    loadBuses(simulationData);
    alert("Simulation reset for all buses!");
}

function trackLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
            const { latitude, longitude } = pos.coords;
            document.getElementById('location-status-1').innerHTML = `<strong>Lat:</strong> ${latitude.toFixed(4)}, <strong>Lon:</strong> ${longitude.toFixed(4)}`;

            // Fetch the full address using a reverse geocoding API
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                if (!response.ok) throw new Error('Failed to fetch address');
                const data = await response.json();
                const address = data.display_name || 'Unknown Location';
                document.getElementById('location-status-1').innerHTML += `<br><strong>Address:</strong> ${address}`;

                const userMarker = L.marker([latitude, longitude], { icon: L.icon({
                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                    shadowSize: [41, 41]
                }) }).addTo(map).bindPopup(`üìç <strong>You are here</strong><br>${address}`).openPopup();
                map.setView([latitude, longitude], 14);
                logEvent(`Tracked Location: Lat ${latitude.toFixed(4)}, Lon ${longitude.toFixed(4)}, Address: ${address}`);
            } catch (error) {
                document.getElementById('location-status-1').innerHTML += `<br><strong>Address:</strong> Unable to fetch address`;
                console.error('Error fetching address:', error);
                logEvent('Failed to fetch address');
            }
        }, err => {
            const errorMessage = err.code === 1 ? 'Location access denied.' : 'Unable to retrieve location.';
            document.getElementById('location-status-1').textContent = errorMessage;
            logEvent(errorMessage);
        });
    } else {
        document.getElementById('location-status-1').textContent = 'Geolocation not supported by your browser.';
        logEvent('Geolocation not supported');
    }
}
const eventLogKey = 'eventLog';
function logEvent(event) {
    const logs = JSON.parse(localStorage.getItem(eventLogKey)) || [];
    logs.push({ event, timestamp: new Date().toLocaleString() });
    localStorage.setItem(eventLogKey, JSON.stringify(logs));
    console.log(`Event Logged: ${event}`);
}

function loadBuses(filteredBuses = busData) {
    // Remove existing markers from the map
    Object.values(busMarkers).forEach(marker => map.removeLayer(marker));
    busMarkers = {};

    // Add new markers for the filtered buses
    filteredBuses.forEach(bus => {
        const marker = L.marker([bus.lat, bus.lon])
            .addTo(map)
            .bindPopup(`üöå <strong>Bus ${bus.id}</strong><br><strong>Route:</strong> ${bus.start} ‚Üí ${bus.destination}<br><strong>Timings:</strong> ${bus.time}`);
        busMarkers[bus.id] = marker;
    });

    // Adjust the map view to fit the markers if any buses are displayed
    const markerPositions = Object.values(busMarkers).map(marker => marker.getLatLng());
    if (markerPositions.length > 0) {
        const bounds = L.latLngBounds(markerPositions);
        map.fitBounds(bounds.pad(0.1));
    } else {
        map.setView([11.0168, 76.9558], 12); // Reset to default view if no buses are displayed
    }

    // Update the table with the filtered buses
    populateTable(filteredBuses);

    // Log the event
    logEvent(`Loaded ${filteredBuses.length} buses on the map`);
}

// Initial load of all buses
loadBuses();
</script>
<script>

const usersKey = 'registeredUsers';

function toggleLoginPasswordVisibility() {
    const pwd = document.getElementById('loginPassword');
    pwd.type = document.getElementById('showLoginPasswordToggle').checked ? 'text' : 'password';
}

function toggleRegisterPasswordVisibility() {
    const pwd = document.getElementById('registerPassword');
    const confirm = document.getElementById('registerConfirmPassword');
    const show = document.getElementById('showRegisterPasswordToggle').checked;
    pwd.type = confirm.type = show ? 'text' : 'password';
}

function sendVerificationCode() {
    const code = Math.floor(100000 + Math.random() * 900000).toString();
    localStorage.setItem('verificationCode', code);
    alert("Verification Code (simulated): " + code);
}

function handleRegister(event) {
    event.preventDefault();
    const name = document.getElementById('registerName').value.trim();
    const phone = document.getElementById('registerPhone').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const pwd = document.getElementById('registerPassword').value.trim();
    const confirm = document.getElementById('registerConfirmPassword').value.trim();
    const code = document.getElementById('verificationCode').value.trim();
    const storedCode = localStorage.getItem('verificationCode');

    const error = document.getElementById('registerError');
    const success = document.getElementById('registerMsg');
    error.style.display = success.style.display = 'none';

    if (!name || !phone || !email || !pwd || !confirm || !code) {
        error.textContent = "Please fill in all fields.";
        error.style.display = 'block';
        return;
    }

    if (pwd !== confirm) {
        error.textContent = "Passwords do not match.";
        error.style.display = 'block';
        return;
    }

    if (code !== storedCode) {
        error.textContent = "Invalid verification code.";
        error.style.display = 'block';
        return;
    }

    const users = JSON.parse(localStorage.getItem(usersKey)) || [];
    if (users.some(u => u.email === email || u.phone === phone)) {
        error.textContent = "User already registered.";
        error.style.display = 'block';
        return;
    }

    users.push({ name, phone, email, password: pwd, smsAlerts: false });
    localStorage.setItem(usersKey, JSON.stringify(users));
    success.textContent = "Registration successful! Please log in.";
    success.style.display = 'block';
    showAlert("Registration successful!");

    setTimeout(() => {
        closePopup('registerModal');
    }, 2000); // Delay for 2 seconds before closing the modal
}

function handleLogin(event) {
    event.preventDefault();
    const id = document.getElementById('loginEmail').value.trim();
    const pwd = document.getElementById('loginPassword').value.trim();
    const error = document.getElementById('loginError');
    error.style.display = 'none';

    const users = JSON.parse(localStorage.getItem(usersKey)) || [];
    const user = users.find(u => (u.email === id || u.phone === id) && u.password === pwd);

    if (user) {
        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('currentUser', JSON.stringify(user));
        showAlert("Login successful!");
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 2000); // Delay for 2 seconds before redirecting
    } else {
        error.textContent = "Invalid email or password.";
        error.style.display = 'block';
        showAlert("Login failed. Please check your credentials.");
    }
}

function saveProfile(event) {
    event.preventDefault();
    const name = document.getElementById('profileName').value.trim();
    const phone = document.getElementById('profilePhone').value.trim();
    const smsAlerts = document.getElementById('smsToggle').checked;

    const users = JSON.parse(localStorage.getItem(usersKey)) || [];
    let currentUser = JSON.parse(localStorage.getItem('currentUser'));

    const updatedUsers = users.map(u => {
        if (u.email === currentUser.email) {
            return { ...u, name, phone, smsAlerts };
        }
        return u;
    });

    localStorage.setItem(usersKey, JSON.stringify(updatedUsers));
    currentUser = { ...currentUser, name, phone, smsAlerts };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));

    const msg = document.getElementById('profileMsg');
    msg.style.display = 'block';
    setTimeout(() => {
        msg.style.display = 'none';
        closePopup('profileModal');
    }, 1500);
}

function logout() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('currentUser');
    showAlert("Logged out!");
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 2000); // Delay for 2 seconds before redirecting
}

function openPopup(id) {
    document.getElementById(id).classList.add('show');
}

function closePopup(id) {
    document.getElementById(id).classList.remove('show');
}

function showAlert(message) {
    const alertBox = document.createElement('div');
    alertBox.textContent = message;
    alertBox.style.position = 'fixed';
    alertBox.style.bottom = '20px';
    alertBox.style.right = '20px';
    alertBox.style.backgroundColor = '#4caf50';
    alertBox.style.color = 'white';
    alertBox.style.padding = '10px 20px';
    alertBox.style.borderRadius = '5px';
    alertBox.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
    alertBox.style.zIndex = '1000';
    document.body.appendChild(alertBox);

    setTimeout(() => {
        alertBox.remove();
    }, 3000);
}
document.addEventListener('DOMContentLoaded', () => {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    const restrictedElements = [
        document.getElementById('map'),
        document.querySelector('.location-tracking-container'),
        document.querySelector('.destination-filter-container'),
        document.querySelector('.voice-search-container')
    ];

    restrictedElements.forEach(element => {
        if (element) {
            element.style.display = isLoggedIn ? 'block' : 'none';
        }
    });
restrictedElements.forEach(element => {
    if (element) {
    element.style.display = isLoggedIn ? 'block' : 'none';
    }
});

const dropdownMenu = document.getElementById('dropdownMenu');
if (!isLoggedIn && dropdownMenu) {
    dropdownMenu.innerHTML = `
    <button onclick="openPopup('loginModal')" style="display: block; width: 100%; margin-bottom: 5px;">üîë Login</button>
    <button onclick="openPopup('registerModal')" style="display: block; width: 100%;">üìù Register</button>
    `;
}
});

function toggleLocationTracking() {
    const locationToggle = document.getElementById('locationTrackingToggle');
    const locationStatus = document.getElementById('location-status-1');

    if (locationToggle.checked) {
        if (navigator.geolocation) {
            alert("Location tracking enabled.");
            logEvent("Location tracking enabled.");
            trackLocation(); // Start tracking location
        } else {
            alert("Location tracking is not supported by your browser.");
            logEvent("Location tracking not supported.");
            locationStatus.textContent = "Location tracking is not supported.";
            locationToggle.checked = false; // Automatically disable toggle
        }
    } else {
        alert("Location tracking disabled.");
        logEvent("Location tracking disabled.");
        locationStatus.textContent = "Location tracking is disabled.";
    }
}
</script>
<script>
    const dailyFeedTips = [
        "üí° Tip: Stay hydrated and take public transport to reduce your carbon footprint!",
        "üå± Eco Tip: Walking short distances saves fuel and keeps you healthy.",
        "üöç Travel Smart: Always check the bus ETA and route before you leave.",
        "üòé Stay Safe: Wear a hat and sunglasses during peak sun hours.",
        "üì± Tech Tip: Bookmark your favorite bus routes for quick access.",
        "üåßÔ∏è Weather Alert: Carry an umbrella if there's a chance of rain today.",
        "üåá Evening Note: Buses might be crowded during rush hour‚Äîplan accordingly.",
        "üéß Commuter Tip: Listen to audiobooks or podcasts while commuting!",
        "üïí Time Saver: Use the traffic simulation to plan the fastest route.",
        "üîã Energy Tip: Dim your phone brightness to save battery while traveling.",
        "üö¶ Safety Tip: Always use pedestrian crossings and follow traffic signals.",
        "üß£ Weather Tip: It might get chilly in the evening‚Äîcarry a light jacket!",
        "üåç Green Living: Carpool or take the bus to help reduce city pollution.",
        "üßò‚Äç‚ôÄÔ∏è Wellness Tip: Deep breathing or meditation can ease commute stress.",
        "üöå Route Reminder: Check for route diversions or maintenance alerts.",
        "üîî Heads up: Enable SMS alerts for your favorite routes to stay updated.",
        "üì∏ Fun Idea: Share a cool photo from your commute using #SmartBusCoimbatore!",
        "üö´ Lost something? Use the feedback section to report lost & found items.",
        "üìä Tracker Tip: Monitor live bus movement and plan like a pro.",
        "üåû Morning Boost: A good breakfast keeps your energy up during travel!"
    ];

    document.addEventListener('DOMContentLoaded', () => {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const dailyFeed = document.getElementById('dailyFeed');
        const feedbackSection = document.getElementById('feedbackSection');

        if (!isLoggedIn) {
            dailyFeed.style.display = 'block';
            feedbackSection.style.display = 'block';
            fetchWeather();
            showRandomTip();
        } else {
            dailyFeed.style.display = 'none';
            feedbackSection.style.display = 'none';
        }
    });

    function fetchWeather() {
        const weatherInfo = document.getElementById('weatherInfo');
        fetch('https://api.open-meteo.com/v1/forecast?latitude=11.0168&longitude=76.9558&current_weather=true')
            .then(response => response.json())
            .then(data => {
                const weather = data.current_weather;
                const temp = weather.temperature;
                const code = weather.weathercode;
                const condition = getWeatherCondition(code);
                weatherInfo.textContent = `Current Weather: ${temp}¬∞C, ${condition}`;
            })
            .catch(() => {
                weatherInfo.textContent = 'Unable to fetch weather information.';
            });
    }

    function getWeatherCondition(code) {
        const conditions = {
            0: "Clear sky",
            1: "Mainly clear",
            2: "Partly cloudy",
            3: "Overcast",
            45: "Fog",
            48: "Depositing rime fog",
            51: "Light drizzle",
            53: "Moderate drizzle",
            55: "Dense drizzle",
            61: "Light rain",
            63: "Moderate rain",
            65: "Heavy rain",
            80: "Rain showers",
            95: "Thunderstorm",
            99: "Heavy thunderstorm"
        };
        return conditions[code] || "Unknown weather";
    }

    function showRandomTip() {
        const tipElement = document.getElementById('dailyTips');
        const randomTip = dailyFeedTips[Math.floor(Math.random() * dailyFeedTips.length)];
        tipElement.textContent = randomTip;
    }

    function submitFeedback(event) {
        event.preventDefault();
        const feedbackInput = document.getElementById('feedbackInput');
        const feedbackMessage = document.getElementById('feedbackMessage');

        if (feedbackInput.value.trim()) {
            feedbackMessage.style.display = 'block';
            feedbackInput.value = '';
            setTimeout(() => {
                feedbackMessage.style.display = 'none';
            }, 3000);
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

    const loggedOutOnlyContent = document.getElementById('loggedOutOnlyContent');
    if (loggedOutOnlyContent) {
        loggedOutOnlyContent.style.display = isLoggedIn ? 'none' : 'block';
    }

    // You can still load feedback if needed
    if (!isLoggedIn) {
        loadFeedbackHistory();
    }
});
document.addEventListener('DOMContentLoaded', () => {
  const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
  const filterSection = document.getElementById('filterSection');
  
  // Show the filter bar only if the user is logged in
  if (isLoggedIn && filterSection) {
    filterSection.style.display = 'block';
  } else {
    filterSection.style.display = 'none';
  }
});

</script>
<script>
    function resetSettings() {
        // Reset all checkboxes and settings to default
        document.getElementById("darkModeToggle").checked = false;
        document.getElementById("voiceToggle").checked = false;
        document.getElementById("notificationsToggle").checked = false;
        document.getElementById("smsAlertToggle").checked = false;
        document.getElementById("autoRefreshToggle").checked = false;
        document.getElementById("locationTrackingToggle").checked = false;
        document.getElementById("languageSelect").value = "en"; // Default language is English

        // Clear localStorage for all settings
        localStorage.removeItem("darkMode");
        localStorage.removeItem("voiceAnnouncements");
        localStorage.removeItem("notificationsEnabled");
        localStorage.removeItem("smsAlertsEnabled");
        localStorage.removeItem("autoRefresh");
        localStorage.removeItem("locationTrackingEnabled");
        localStorage.removeItem("language");

        speak("Settings have been reset to default.");
    }
    // Function to open the modal
    function openPopup(id) {
        document.getElementById(id).style.display = "block";
    }

    // Function to close the modal
    function closePopup(id) {
        document.getElementById(id).style.display = "none";
    }

    // Function to load saved settings from localStorage
    window.onload = function () {
        // Load settings from localStorage
        const darkMode = localStorage.getItem("darkMode") === "true";
        const voiceEnabled = localStorage.getItem("voiceAnnouncements") === "true";
        const notificationsEnabled = localStorage.getItem("notificationsEnabled") === "true";
        const smsAlertsEnabled = localStorage.getItem("smsAlertsEnabled") === "true";
        const autoRefresh = localStorage.getItem("autoRefresh") === "true";
        const locationTrackingEnabled = localStorage.getItem("locationTrackingEnabled") === "true";
        const selectedLanguage = localStorage.getItem("language") || "en";

        // Apply saved settings
        document.getElementById("darkModeToggle").checked = darkMode;
        document.getElementById("voiceToggle").checked = voiceEnabled;
        document.getElementById("notificationsToggle").checked = notificationsEnabled;
        document.getElementById("smsAlertToggle").checked = smsAlertsEnabled;
        document.getElementById("autoRefreshToggle").checked = autoRefresh;
        document.getElementById("locationTrackingToggle").checked = locationTrackingEnabled;
        document.getElementById("languageSelect").value = selectedLanguage;
    }
    // Additional functionality can be added here if needed
    function toggleDarkMode() {
        const isDarkMode = document.getElementById("darkModeToggle").checked;
        if (isDarkMode) {
            document.body.classList.add("dark-mode");
            localStorage.setItem("darkMode", "true");
        } else {
            document.body.classList.remove("dark-mode");
            localStorage.setItem("darkMode", "false");
        }
    }

    function changeLanguage() {
        const selectedLanguage = document.getElementById("languageSelect").value;
        localStorage.setItem("language", selectedLanguage);
        alert(`Language changed to ${selectedLanguage}`);
        // Additional logic to update UI text based on the selected language can be added here
    }

    function toggleNotifications() {
        const isEnabled = document.getElementById("notificationsToggle").checked;
        localStorage.setItem("notificationsEnabled", isEnabled.toString());
        alert(isEnabled ? "Notifications enabled." : "Notifications disabled.");
    }

    function toggleSmsAlerts() {
        const isEnabled = document.getElementById("smsAlertToggle").checked;
        localStorage.setItem("smsAlertsEnabled", isEnabled.toString());
        alert(isEnabled ? "SMS Alerts enabled for favorite routes." : "SMS Alerts disabled.");
    }

    function toggleVoiceAnnouncements() {
        const isEnabled = document.getElementById("voiceToggle").checked;
        localStorage.setItem("voiceAnnouncements", isEnabled.toString());
        alert(isEnabled ? "Voice Announcements enabled." : "Voice Announcements disabled.");
    }

    function toggleAutoRefresh() {
        const isEnabled = document.getElementById("autoRefreshToggle").checked;
        localStorage.setItem("autoRefresh", isEnabled.toString());
        alert(isEnabled ? "Auto-Refresh for bus data enabled." : "Auto-Refresh for bus data disabled.");
    }

    function toggleLocationTracking() {
        const isEnabled = document.getElementById("locationTrackingToggle").checked;
        localStorage.setItem("locationTrackingEnabled", isEnabled.toString());
        alert(isEnabled ? "Location Tracking enabled." : "Location Tracking disabled.");
        if (isEnabled) {
            trackLocation();
        }
    }

    function resetSettings() {
        document.getElementById("darkModeToggle").checked = false;
        document.getElementById("voiceToggle").checked = false;
        document.getElementById("notificationsToggle").checked = false;
        document.getElementById("smsAlertToggle").checked = false;
        document.getElementById("autoRefreshToggle").checked = false;
        document.getElementById("locationTrackingToggle").checked = false;
        document.getElementById("languageSelect").value = "en";

        localStorage.removeItem("darkMode");
        localStorage.removeItem("voiceAnnouncements");
        localStorage.removeItem("notificationsEnabled");
        localStorage.removeItem("smsAlertsEnabled");
        localStorage.removeItem("autoRefresh");
        localStorage.removeItem("locationTrackingEnabled");
        localStorage.removeItem("language");

        alert("Settings have been reset to default.");
    }
</script>

</body>
</html>
