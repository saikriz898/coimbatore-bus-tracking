<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üöåSmart Bus Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome-animation/1.0.0/font-awesome-animation.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome-animation/1.0.0/font-awesome-animation.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome-animation/1.0.0/font-awesome-animation.min.css"/>
    <link rel="stylesheet" href="styles.css"/>
    <script src="script.js"></script>
</head>
<div>

<nav>
    <h1>üöåSmart Bus Tracker</h1>
    <div class="nav-buttons" style="display: flex; align-items: center; gap: 10px;"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const navButtons = document.querySelector('.nav-buttons');
            if (isLoggedIn) {
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                navButtons.innerHTML = `
                    <div style="display: flex; align-items: center; position: relative;">
                        <img src="${currentUser?.profilePic || 'https://via.placeholder.com/80'}" alt="Profile" id="profileImage" class="profile-image" onclick="hideNavBar(); openPopup('profileModal')" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid #555; transition: transform 0.3s ease-in-out;">
                        <button class="dropdown-toggle" onclick="toggleDropdown()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #ccc; margin-left: 10px;">‚ãÆ</button>
                        <div class="dropdown-content" id="dropdownMenu" style="display: none; position: absolute; top: 70px; right: 0; background: #333; border-radius: 12px; z-index: 1000; overflow: hidden; max-height: 300px; overflow-y: auto;">
                            <div class="dropdown-header" style="text-align: center; padding: 15px; border-bottom: 1px solid #444;">
                                <img src="${currentUser?.profilePic || 'https://via.placeholder.com/100'}" alt="Profile" id="dropdownProfileImage" class="dropdown-profile-image" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #666; transition: transform 0.3s ease-in-out;">
                                <p class="dropdown-name" style="margin: 10px 0 5px; color: #ccc; font-weight: bold; font-size: 1rem;">üë§ ${currentUser?.name || 'User'}</p>
                                <p class="dropdown-email" style="color: #aaa; font-size: 0.8rem;">üìß ${currentUser?.email || 'N/A'}</p>
                            </div>
                            <div class="dropdown-buttons" style="display: flex; flex-direction: column; gap: 8px; padding: 10px;">
                                <button onclick="hideNavBar(); openPopup('profileModal')" class="dropdown-button" style="background: #444; color: #ccc; padding: 10px; border-radius: 8px; border: 1px solid #555; cursor: pointer; font-size: 0.9rem;">üë§ Edit Profile</button>
                                <button onclick="hideNavBar(); openPopup('favoritesModal')" class="dropdown-button" style="background: #444; color: #ccc; padding: 10px; border-radius: 8px; border: 1px solid #555; cursor: pointer; font-size: 0.9rem;">‚≠ê Favorites</button>
                                <button onclick="hideNavBar(); openPopup('notificationsModal')" class="dropdown-button" style="background: #444; color: #ccc; padding: 10px; border-radius: 8px; border: 1px solid #555; cursor: pointer; font-size: 0.9rem;">üîî Notifications</button>
                                <button onclick="hideNavBar(); openPopup('smsNotification')" class="dropdown-button" style="background: #444; color: #ccc; padding: 10px; border-radius: 8px; border: 1px solid #555; cursor: pointer; font-size: 0.9rem;">üì© SMS Notification</button>
                                <button onclick="hideNavBar(); openPopup('trafficUpdatesModal')" class="dropdown-button" style="background: #444; color: #ccc; padding: 10px; border-radius: 8px; border: 1px solid #555; cursor: pointer; font-size: 0.9rem;">üö¶ Traffic Updates</button>
                                <button onclick="hideNavBar(); showModal()" class="dropdown-button" style="background: #444; color: #ccc; padding: 10px; border-radius: 8px; border: 1px solid #555; cursor: pointer; font-size: 0.9rem;">üöå Bus Info</button>
                                <button onclick="hideNavBar(); openPopup('settingsModal')" class="dropdown-button" style="background: #444; color: #ccc; padding: 10px; border-radius: 8px; border: 1px solid #555; cursor: pointer; font-size: 0.9rem;">‚öôÔ∏è Settings</button>
                                <button onclick="hideNavBar(); openPopup('helpModal')" class="dropdown-button" style="background: #444; color: #ccc; padding: 10px; border-radius: 8px; border: 1px solid #555; cursor: pointer; font-size: 0.9rem;">‚ùì Help</button>
                                <button onclick="hideNavBar(); logout()" class="dropdown-button logout-button" style="background: #550000; color: #ff6666; padding: 10px; border-radius: 8px; border: 1px solid #555; cursor: pointer; font-size: 0.9rem;">üö™ Logout</button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                navButtons.innerHTML = `
                    <button onclick="openPopup('loginModal')" style="background: var(--primary-color); color: #fff; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;">Login</button>
                    <button onclick="openPopup('registerModal')" style="background: var(--primary-color); color: #fff; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;">Register</button>
                `;
            }
        });
        function hideNavBar() {
            const dropdownMenu = document.getElementById('dropdownMenu');
            if (dropdownMenu) {
            dropdownMenu.style.display = 'none';
            }
        }

        function toggleDropdown() {
            const dropdownMenu = document.getElementById('dropdownMenu');
            dropdownMenu.style.display = dropdownMenu.style.display === 'none' || dropdownMenu.style.display === '' ? 'block' : 'none';
        }

        document.addEventListener('click', (event) => {
            const dropdownMenu = document.getElementById('dropdownMenu');
            const toggleButton = document.querySelector('button[onclick="toggleDropdown()"]');
            if (dropdownMenu && !dropdownMenu.contains(event.target) && event.target !== toggleButton) {
                dropdownMenu.style.display = 'none';
            }
        });

        function updateProfileImage(newImageUrl) {
            const profileImage = document.getElementById('profileImage');
            const dropdownProfileImage = document.getElementById('dropdownProfileImage');
            const defaultImage = 'https://via.placeholder.com/60';

            profileImage.src = newImageUrl || defaultImage;
            dropdownProfileImage.src = newImageUrl || defaultImage;

            // Save the updated profile image to localStorage
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
            currentUser.profilePic = newImageUrl || defaultImage;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }

        function updateProfilePicture(event) {
            const file = event.target.files[0];
            if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const newImageUrl = e.target.result;
                document.getElementById('profilePic').src = newImageUrl;
                updateProfileImage(newImageUrl);
            };
            reader.readAsDataURL(file);
            }
        }

        function saveProfile(event) {
            event.preventDefault();
            const name = document.getElementById('profileName').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            const smsAlerts = document.getElementById('smsToggle').checked;

            const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
            let currentUser = JSON.parse(localStorage.getItem('currentUser'));

            if (!currentUser) {
            alert('No user is currently logged in.');
            return;
            }

            const updatedUsers = users.map(u => {
            if (u.email === currentUser.email) {
                return { ...u, name, phone, smsAlerts };
            }
            return u;
            });

            localStorage.setItem('registeredUsers', JSON.stringify(updatedUsers));
            currentUser = { ...currentUser, name, phone, smsAlerts };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            // Update navbar and dropdown profile immediately
            document.getElementById('profileImage').src = currentUser.profilePic || 'https://via.placeholder.com/60';
            document.getElementById('dropdownProfileImage').src = currentUser.profilePic || 'https://via.placeholder.com/100';
            document.querySelector('.dropdown-content p').textContent = `üë§ ${currentUser.name || 'User'}`;

            const msg = document.getElementById('profileMsg');
            msg.style.display = 'block';
            setTimeout(() => {
            msg.style.display = 'none';
            closePopup('profileModal');
            }, 1500);
        }
    </script>
</nav>
<div id="profileModal" class="modal" style="background: #000; color: #fff; padding: 2rem; border-radius: 15px; box-shadow: 0 0 25px rgba(255, 255, 255, 0.2); font-family: 'Poppins', sans-serif;">
    <button class="close-btn" onclick="closePopup('profileModal')" style="position: absolute; top: 15px; right: 15px; background: #262626; color: #fff; border: none; border-radius: 50%; width: 35px; height: 35px; font-size: 18px; cursor: pointer; box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);">√ó</button>
    <h2 style="text-align: center; color: #fff; font-weight: 600;">Edit Profile</h2>
    <form onsubmit="saveProfile(event)" style="margin-top: 1.5rem;">
        <div class="profile-pic-container" style="text-align: center; margin-bottom: 1.5rem;">
            <img id="profilePic" src="https://via.placeholder.com/100" alt="Profile Picture" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);">
            <div style="margin-top: 10px;">
                <button type="button" onclick="document.getElementById('profilePicInput').click()" style="background: #0095f6; color: #fff; padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Change Picture</button>
                <button type="button" onclick="removeProfilePicture()" style="background: #ed4956; color: #fff; padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">Remove Picture</button>
                <input type="file" id="profilePicInput" accept="image/*" style="display: none;" onchange="updateProfilePicture(event)">
            </div>
        </div>
        <div style="margin-bottom: 1.5rem;">
            <label for="profileName" style="color: #8e8e8e; font-weight: bold;">Name:</label>
            <input type="text" id="profileName" placeholder="Enter your name" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #262626; color: #fff; border: 1px solid #8e8e8e; margin-top: 5px;">
        </div>
        <div style="margin-bottom: 1.5rem;">
            <label for="profilePhone" style="color: #8e8e8e; font-weight: bold;">Phone:</label>
            <input type="text" id="profilePhone" placeholder="Enter your phone number" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #262626; color: #fff; border: 1px solid #8e8e8e; margin-top: 5px;">
        </div>
        <div style="margin-bottom: 1.5rem;">
            <label for="profileEmail" style="color: #8e8e8e; font-weight: bold;">Email:</label>
            <input type="email" id="profileEmail" placeholder="Enter your email" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #262626; color: #fff; border: 1px solid #8e8e8e; margin-top: 5px;" disabled>
        </div>
        <div style="margin-bottom: 1.5rem;">
            <label style="color: #8e8e8e; font-weight: bold; display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="smsToggle">
                Enable SMS Alerts
            </label>
        </div>
        <div style="margin-bottom: 1.5rem;">
            <label for="profileBio" style="color: #8e8e8e; font-weight: bold;">Bio:</label>
            <textarea id="profileBio" placeholder="Tell us about yourself" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #262626; color: #fff; border: 1px solid #8e8e8e; margin-top: 5px;"></textarea>
        </div>
        <button type="submit" style="width: 100%; padding: 12px; border-radius: 10px; background-color: #0095f6; color: #fff; font-weight: bold; font-size: 1rem; cursor: pointer; box-shadow: 0 0 10px rgba(0, 149, 246, 0.5);">Save Changes</button>
    </form>
    <p id="profileMsg" style="color: #58c322; display: none; margin-top: 1.5rem; text-align: center;">Profile updated successfully!</p>
</div>
<script>
    function saveProfile(event) {
        event.preventDefault();
        const name = document.getElementById('profileName').value.trim();
        const phone = document.getElementById('profilePhone').value.trim();
        const bio = document.getElementById('profileBio').value.trim();
        const smsAlerts = document.getElementById('smsToggle').checked;

        const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
        const updatedUser = { ...currentUser, name, phone, bio, smsAlerts };

        localStorage.setItem('currentUser', JSON.stringify(updatedUser));

        const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
        const updatedUsers = users.map(user => user.email === currentUser.email ? updatedUser : user);
        localStorage.setItem('registeredUsers', JSON.stringify(updatedUsers));

        document.getElementById('profileMsg').style.display = 'block';
        setTimeout(() => {
            document.getElementById('profileMsg').style.display = 'none';
            closePopup('profileModal');
        }, 1500);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const currentUser = JSON.parse(localStorage.getItem('currentUser')) || {};
        document.getElementById('profileName').value = currentUser.name || '';
        document.getElementById('profilePhone').value = currentUser.phone || '';
        document.getElementById('profileEmail').value = currentUser.email || '';
        document.getElementById('profileBio').value = currentUser.bio || '';
        document.getElementById('smsToggle').checked = currentUser.smsAlerts || false;
        document.getElementById('profilePic').src = currentUser.profilePic || 'https://via.placeholder.com/100';
    });

    function removeProfilePicture() {
        const defaultImage = 'https://via.placeholder.com/100';
        document.getElementById('profilePic').src = defaultImage;
        updateProfileImage(defaultImage);
    }

    function updateProfilePicture(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const newImageUrl = e.target.result;
                document.getElementById('profilePic').src = newImageUrl;
                updateProfileImage(newImageUrl);
            };
            reader.readAsDataURL(file);
        }
    }

    function updateProfileImage(newImageUrl) {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser) {
            currentUser.profilePic = newImageUrl || 'https://via.placeholder.com/100';
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        }
    }
</script>
<!-- Removed duplicate script block to avoid redundancy -->

<div id="filterSection" style="display: none;">
    <div class="filter-container" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between; padding: 1rem; background: var(--card-bg); border-radius: 10px; box-shadow: var(--neon-glow);">
      <!-- Location Tracking -->
    <div class="location-tracking-container" style="position: absolute; bottom: 10px; left: 10px; z-index: 1000; background: rgba(0, 0, 0, 0.7); padding: 10px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">
        <button onclick="trackLocation()" style="padding: 10px 20px; border-radius: 8px; background: var(--accent-color); color: #fff; font-weight: bold; cursor: pointer;">üìç Locate Me</button>
        <p id="location-status-1" style="margin-top: 10px; color: #fff; font-size: 0.9rem;">Location status will appear here.</p>
    </div>
      <!-- Destination Filter -->
      <div class="destination-filter-container" style="flex: 1; text-align: center;">
        <label for="destination-filter" style="color: var(--text-color); font-weight: bold; margin-right: 10px;">Filter by Destination:</label>
        <select id="destination-filter" onchange="filterByDestination(this.value)" style="padding: 10px; border-radius: 8px; background: var(--card-bg); color: var(--text-color); border: 1px solid var(--accent-color); box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">
          <option value="">All Destinations</option>
        </select>
      </div>
  
      <!-- Voice Search -->
      <div class="voice-search-container" style="flex: 1; text-align: center;">
        <button onclick="startVoiceSearch()" style="padding: 10px 20px; border-radius: 8px; background: var(--primary-color); color: #fff; font-weight: bold; cursor: pointer; box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">üé§ Voice Search</button>
        <p id="voice-search-status" style="margin-top: 10px; color: var(--text-color); font-size: 0.9rem;">Speak to search for a destination.</p>
      </div>
    </div>
  </div>
  
    <script>
        function startVoiceSearch() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (!isLoggedIn) {
                alert('Please log in to use the voice search feature.');
                return;
            }

            if (!('webkitSpeechRecognition' in window)) {
                alert('Voice search is not supported in this browser.');
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                document.getElementById('voice-search-status').textContent = 'Listening...';
                const utterance = new SpeechSynthesisUtterance('I am listening. Please say your destination.');
                window.speechSynthesis.speak(utterance);
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('voice-search-status').textContent = `You said: "${transcript}"`;
                const utterance = new SpeechSynthesisUtterance(`You said ${transcript}. Searching for buses.`);
                window.speechSynthesis.speak(utterance);

                const filteredBuses = busData.filter(bus => bus.destination.toLowerCase().includes(transcript.toLowerCase()));
                if (filteredBuses.length > 0) {
                    const table = document.createElement('table');
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                    table.style.marginTop = '10px';

                    const headerRow = document.createElement('tr');
                    headerRow.innerHTML = `
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Bus ID</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Start</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Destination</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Timings</th>
                        <th style="border: 1px solid #ccc; padding: 8px; text-align: left;">Action</th>
                    `;
                    table.appendChild(headerRow);

                    filteredBuses.forEach(bus => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="border: 1px solid #ccc; padding: 8px;">${bus.id}</td>
                            <td style="border: 1px solid #ccc; padding: 8px;">${bus.start}</td>
                            <td style="border: 1px solid #ccc; padding: 8px;">${bus.destination}</td>
                            <td style="border: 1px solid #ccc; padding: 8px;">${bus.time}</td>
                            <td style="border: 1px solid #ccc; padding: 8px;">
                                <button onclick="addTracking('${bus.id}')" style="padding: 5px 10px; border-radius: 5px; background: var(--accent-color); color: #fff; border: none; cursor: pointer;">Track</button>
                            </td>
                        `;
                        table.appendChild(row);
                    });

                    const voiceSearchStatus = document.getElementById('voice-search-status');
                    voiceSearchStatus.textContent = '';
                    voiceSearchStatus.appendChild(table);

                    const summary = `Found ${filteredBuses.length} buses.`;
                    const utterance = new SpeechSynthesisUtterance(summary);
                    window.speechSynthesis.speak(utterance);

                    // Show buses on the map
                    loadBuses(filteredBuses);
                } else {
                    const utterance = new SpeechSynthesisUtterance('No buses found for the given destination.');
                    window.speechSynthesis.speak(utterance);
                    document.getElementById('voice-search-status').textContent = 'No buses found.';
                }
            };

            recognition.onerror = (event) => {
                document.getElementById('voice-search-status').textContent = 'Error occurred during voice recognition.';
                const utterance = new SpeechSynthesisUtterance('An error occurred during voice recognition. Please try again.');
                window.speechSynthesis.speak(utterance);
                console.error('Voice recognition error:', event.error);
            };

            recognition.start();
        }
    </script>
</div>
<div id="loggedOutOnlyContent" style="display: none;">
    <div id="dailyFeed" style="margin-top: 20px; padding: 1rem; background: var(--card-bg); border-radius: 10px; box-shadow: var(--neon-glow);">
        <h2 style="color: var(--primary-color); text-align: center; text-shadow: 0 0 10px var(--primary-color);">üå§Ô∏è Daily Feed & Weather</h2>
        <p id="weatherInfo" style="color: var(--text-color); font-size: 1.1rem; text-align: center;">Fetching weather information...</p>
        <p id="dailyTips" style="color: var(--text-color); margin-top: 10px; font-size: 1rem; text-align: center;">Loading tip of the day...</p>
    </div>

    <div id="feedbackSection" style="margin-top: 20px; padding: 1.5rem; background: var(--card-bg); border-radius: 12px; box-shadow: var(--neon-glow);">
        <h2 style="color: var(--primary-color); text-align: center; text-shadow: 0 0 10px var(--primary-color);">üìù Share Your Feedback</h2>
        <form onsubmit="submitFeedback(event)" style="display: flex; flex-direction: column; gap: 1.5rem; margin-top: 1rem;">
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <label for="feedbackName" style="color: var(--text-color); font-weight: bold;">Your Name:</label>
                <input type="text" id="feedbackName" placeholder="Enter your name" style="padding: 10px; border-radius: 8px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--accent-color);">
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <label for="feedbackInput" style="color: var(--text-color); font-weight: bold;">Your Feedback:</label>
                <textarea id="feedbackInput" placeholder="Share your thoughts..." rows="4" style="padding: 10px; border-radius: 8px; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--accent-color);"></textarea>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <label style="color: var(--text-color); font-weight: bold;">Rate Us:</label>
                <div style="display: flex; gap: 10px;">
                    <label><input type="radio" name="rating" value="1"> ‚≠ê</label>
                    <label><input type="radio" name="rating" value="2"> ‚≠ê‚≠ê</label>
                    <label><input type="radio" name="rating" value="3"> ‚≠ê‚≠ê‚≠ê</label>
                    <label><input type="radio" name="rating" value="4"> ‚≠ê‚≠ê‚≠ê‚≠ê</label>
                    <label><input type="radio" name="rating" value="5"> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</label>
                </div>
            </div>
            <button type="submit" style="padding: 10px 20px; border-radius: 8px; background: var(--accent-color); color: #fff; font-weight: bold; cursor: pointer; box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);">Submit Feedback</button>
        </form>
    </div>
</div>


<script>
    const feedbackKey = 'userFeedback';

    function submitFeedback(event) {
        event.preventDefault();
        const feedbackName = document.getElementById('feedbackName').value.trim();
        const feedbackInput = document.getElementById('feedbackInput').value.trim();
        const rating = document.querySelector('input[name="rating"]:checked')?.value;
        const feedbackMessage = document.getElementById('feedbackMessage');

        if (!feedbackName || !feedbackInput || !rating) {
            alert('Please fill in all fields and select a rating.');
            return;
        }

        const feedback = {
            name: feedbackName,
            text: feedbackInput,
            rating: rating,
            timestamp: new Date().toLocaleString()
        };

        const feedbackList = JSON.parse(localStorage.getItem(feedbackKey)) || [];
        feedbackList.push(feedback);
        localStorage.setItem(feedbackKey, JSON.stringify(feedbackList));

        feedbackMessage.style.display = 'block';
        feedbackMessage.textContent = 'Thank you for your feedback!';
        document.getElementById('feedbackName').value = '';
        document.getElementById('feedbackInput').value = '';
        document.querySelector('input[name="rating"]:checked').checked = false;

        setTimeout(() => {
            feedbackMessage.style.display = 'none';
        }, 3000);

        loadFeedbackHistory();
        }

        function loadFeedbackHistory() {
        const feedbackList = JSON.parse(localStorage.getItem(feedbackKey)) || [];
        const feedbackHistory = document.getElementById('feedbackHistory');
        if (!feedbackHistory) {
            console.error('Feedback history element not found in the DOM.');
            return;
        }
        feedbackHistory.innerHTML = '';

        if (feedbackList.length === 0) {
            feedbackHistory.innerHTML = '<li style="text-align: center; color: var(--text-color); font-style: italic;">No feedback available yet. Be the first to share your thoughts!</li>';
            return;
        }

        feedbackList.forEach(feedback => {
            const li = document.createElement('li');
            li.style.marginBottom = '10px';
            li.style.padding = '10px';
            li.style.border = '1px solid var(--accent-color)';
            li.style.borderRadius = '8px';
            li.style.backgroundColor = 'var(--card-bg)';
            li.style.boxShadow = '0 0 10px rgba(0, 255, 255, 0.3)';
            li.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong style="color: var(--primary-color);">${feedback.timestamp}</strong>
                <span style="color: gold; font-weight: bold;">‚≠ê ${feedback.rating}/5</span>
            </div>
            <p style="margin: 5px 0; color: var(--text-color);"><em>${feedback.name}</em> said:</p>
            <p style="margin: 0; color: var(--text-color); font-style: italic;">"${feedback.text}"</p>
            `;
            feedbackHistory.appendChild(li);
        });

        // Scroll to the latest feedback
        feedbackHistory.scrollTop = feedbackHistory.scrollHeight;
        }

    document.addEventListener('DOMContentLoaded', () => {
        const feedbackHistory = document.getElementById('feedbackHistory');
        if (feedbackHistory) {
            loadFeedbackHistory();
        } else {
            console.error('Feedback history element not found in the DOM during page load.');
        }
    });
</script>


<div id="map" style="height: 500px; border: 2px solid #ccc; border-radius: 10px; margin-top: 10px;"></div>

<div class="modal" id="busModal" style="width: 90%; max-width: 800px; background: var(--modal-bg); color: var(--text-color); padding: 1.5rem; border-radius: 12px; box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);">
    <button class="close-btn" onclick="hideModal()" style="position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #ff0059, #ff4081); color: #fff; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 16px; cursor: pointer; box-shadow: 0 0 15px rgba(255, 0, 89, 0.7);">√ó</button>
    <h2 style="text-align: center; color: var(--primary-color); text-shadow: var(--neon-glow);">Bus Information</h2>
    <div style="overflow-x: auto; max-height: 70vh; margin-top: 1rem;">
        <table style="width: 100%; border-collapse: collapse; background-color: #222; border: 2px solid var(--accent-color); box-shadow: var(--neon-glow); color: var(--text-color);">
            <thead style="background-color: #333; color: var(--primary-color);">
                <tr>
                    <th style="padding: 14px; border-bottom: 1px solid #444; text-align: left;">ID</th>
                    <th style="padding: 14px; border-bottom: 1px solid #444; text-align: left;">Start</th>
                    <th style="padding: 14px; border-bottom: 1px solid #444; text-align: left;">Destination</th>
                    <th style="padding: 14px; border-bottom: 1px solid #444; text-align: left;">Timings</th>
                    <th style="padding: 14px; border-bottom: 1px solid #444; text-align: left;">Action</th>
                </tr>
            </thead>
            <tbody id="busTable"></tbody>
        </table>
    </div>
</div>

<div class="modal" id="smsNotification">
    <button class="close-btn" onclick="closePopup('smsNotification')">√ó</button>
    <h2>SMS Notification</h2>
    <form onsubmit="enableSmsNotification(event)">
        <input type="tel" id="phoneNumber" required placeholder="Enter your phone number" />
        <button type="submit">Enable Alerts</button>
    </form>
</div>

<div class="modal" id="historyModal">
    <button class="close-btn" onclick="closePopup('historyModal')">√ó</button>
    <h2>Notification History</h2>
    <ul id="historyList" style="list-style-type: none;"></ul>
</div>
<div class="modal" id="loginModal" style="background: #1a1a1a; color: #fff; padding: 2rem; border-radius: 15px; box-shadow: 0 0 25px rgba(255, 255, 255, 0.2); font-family: 'Poppins', sans-serif; display: none;">
    <button class="close-btn" onclick="closePopup('loginModal')">√ó</button>
    <h2 class="modal-title">üîë Login to SmartBus</h2>
    <form onsubmit="handleLogin(event)" class="modal-form">
        <div class="input-container">
            <input type="text" id="loginEmail" required placeholder="üìß Email or Phone" class="input-field" />
        </div>
        <div class="input-container">
            <input type="password" id="loginPassword" required placeholder="üîí Password" class="input-field" />
        </div>
        <label class="checkbox-label">
            <input type="checkbox" id="showLoginPasswordToggle" onclick="toggleLoginPasswordVisibility()" />
            Show Password
        </label>
        <button type="submit" id="loginButton" class="modal-button">Login</button>
        <p id="loginError" class="error-message">‚ùå Invalid email or password. Please try again.</p>
    </form>
    <div class="modal-footer">
        <p>Forgot your password? 
            <button onclick="closePopup('loginModal'); openPopup('forgotPasswordModal');" class="link-button">Reset Password</button>
        </p>
        <p>Don't have an account? 
            <button onclick="closePopup('loginModal'); openPopup('registerModal');" class="link-button">Register</button>
        </p>
    </div>
</div>
<!-- Register Modal -->
<div class="modal" id="registerModal">
    <button class="close-btn" onclick="closePopup('registerModal')">√ó</button>
    <h2 class="modal-title">üìù Register</h2>
  
    <form id="registerForm" onsubmit="handleRegister(event)" class="modal-form">
      <input type="text" id="registerName"  placeholder="üë§ Name" class="input-field" required>
      <input type="text" id="registerPhone" placeholder="üìû Phone" class="input-field" required>
      <input type="email" id="registerEmail" placeholder="üìß Email" class="input-field" required>
  
      <div class="input-container">
        <input type="password" id="registerPassword" placeholder="üîí Password" class="input-field" required>
        <label class="checkbox-label">
          <input type="checkbox" id="showRegisterPasswordToggle" onclick="toggleRegisterPasswordVisibility()">
          Show Password
        </label>
      </div>
  
      <div class="input-container">
        <input type="password" id="registerConfirmPassword" placeholder="üîí Confirm Password" class="input-field" required>
      </div>
  
      <!-- Send‚Äëcode button -->
    <button type="button" onclick="sendVerificationCode();" class="modal-button">
      üì© Send Verification Code
    </button>
    
  
      <!-- Hidden until code is sent -->
      <div id="verificationSection" style="display:none;">
        <input type="text" id="verificationCode" placeholder="üîë Enter Verification Code"
               class="input-field" required>
        <button type="submit" id="registerButton" class="modal-button">
          Register
        </button>
        <p id="registerMsg" class="success-message">‚úÖ Registration successful! Please log in.</p>
      </div>
    </form>
  
    <p id="registerError" class="error-message">‚ùå Registration failed. Please try again.</p>
  
    <div class="modal-footer">
      <p>Already have an account?
        <button class="link-button"
                onclick="closePopup('registerModal'); openPopup('loginModal');">
          Login
        </button>
      </p>
    </div>
  </div>

<div class="modal" id="forgotPasswordModal">
    <button class="close-btn" onclick="closePopup('forgotPasswordModal')">√ó</button>
    <h2 class="modal-title">üîí Forgot Password</h2>
    <form onsubmit="handleForgotPassword(event)" class="modal-form">
        <div class="input-container">
            <input type="email" id="forgotPasswordEmail" required placeholder="üìß Enter your registered email" class="input-field" />
        </div>
        <button type="submit" class="modal-button">Reset Password</button>
    </form>
    <p id="forgotPasswordMsg" class="success-message">‚úÖ Password reset instructions sent to your email.</p>
    <p id="forgotPasswordError" class="error-message">‚ùå Failed to send reset instructions. Please try again.</p>
</div>
<script>
    function removeProfilePic(index) {
        const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
        users[index].profilePic = 'https://via.placeholder.com/100'; // Reset to default profile picture
        localStorage.setItem('registeredUsers', JSON.stringify(users));

        document.getElementById(`profilePic-${index}`).src = 'https://via.placeholder.com/100';
    }

    function updateProfilePic(event, index) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
                users[index].profilePic = e.target.result;
                localStorage.setItem('registeredUsers', JSON.stringify(users));

                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser?.email === users[index].email) {
                    localStorage.setItem('currentUser', JSON.stringify(users[index]));
                }

                document.getElementById(`profilePic-${index}`).src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    function saveUserUpdate(index) {
        const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];

        const nameInput = document.querySelector(`.adminInput[data-index="${index}"][data-field="name"]`);
        const phoneInput = document.querySelector(`.adminInput[data-index="${index}"][data-field="phone"]`);
        const smsCheckbox = document.querySelector(`.adminCheckbox[data-index="${index}"][data-field="smsAlerts"]`);

        if (nameInput && phoneInput && smsCheckbox) {
            users[index].name = nameInput.value.trim();
            users[index].phone = phoneInput.value.trim();
            users[index].smsAlerts = smsCheckbox.checked;

            localStorage.setItem('registeredUsers', JSON.stringify(users));

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser?.email === users[index].email) {
                localStorage.setItem('currentUser', JSON.stringify(users[index]));
            }

            const msg = document.getElementById('adminMsg');
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
                closePopup('adminPanelModal'); // Close the modal after saving
            }, 1500);
        }
    }
function removeProfilePic(index) {
    const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
    users[index].profilePic = 'https://via.placeholder.com/100'; // Reset to default profile picture
    localStorage.setItem('registeredUsers', JSON.stringify(users));

    document.getElementById(`profilePic-${index}`).src = 'https://via.placeholder.com/100';
}

function updateProfilePic(event, index) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
            users[index].profilePic = e.target.result;
            localStorage.setItem('registeredUsers', JSON.stringify(users));

            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser?.email === users[index].email) {
                localStorage.setItem('currentUser', JSON.stringify(users[index]));
            }

            document.getElementById(`profilePic-${index}`).src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
}

function saveUserUpdate(index) {
    const users = JSON.parse(localStorage.getItem('registeredUsers')) || [];

    const nameInput = document.querySelector(`.adminInput[data-index="${index}"][data-field="name"]`);
    const phoneInput = document.querySelector(`.adminInput[data-index="${index}"][data-field="phone"]`);
    const smsCheckbox = document.querySelector(`.adminCheckbox[data-index="${index}"][data-field="smsAlerts"]`);

    if (nameInput && phoneInput && smsCheckbox) {
        users[index].name = nameInput.value.trim();
        users[index].phone = phoneInput.value.trim();
        users[index].smsAlerts = smsCheckbox.checked;

        localStorage.setItem('registeredUsers', JSON.stringify(users));

        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser?.email === users[index].email) {
            localStorage.setItem('currentUser', JSON.stringify(users[index]));
        }

        const msg = document.getElementById('adminMsg');
        msg.style.display = 'block';
        setTimeout(() => {
            msg.style.display = 'none';
            closePopup('adminPanelModal'); // Close the modal after saving
        }, 1500);
    }
}
</script>
<div class="modal" id="favoritesModal">
    <button class="close-btn" onclick="closePopup('favoritesModal')">√ó</button>
    <h2>Favorites</h2>
    <ul id="favoritesList"></ul>
    <form onsubmit="addFavorite(event)">
        <input type="text" id="newFavorite" required placeholder="Add Bus ID" />
        <button type="submit">Add</button>
    </form>
</div>

<!-- Notifications Modal -->
<div class="modal" id="notificationsModal">
    <button class="close-btn" onclick="closePopup('notificationsModal')">√ó</button>
    <h2>Notifications</h2>
    <ul id="notificationsList"></ul>
    <button onclick="refreshNotifications()">Refresh</button>
</div>

<!-- Enhanced Settings Modal -->
<div class="modal" id="settingsModal">
    <button class="close-btn" onclick="closePopup('settingsModal')">√ó</button>
    <h2>‚öôÔ∏è Settings</h2>
    <div class="setting-option">
        <label>
            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()" />
            üåô Dark Mode
        </label>
    </div>

    <div class="setting-option">
        <label>
            üåê Language:
            <select id="languageSelect" onchange="changeLanguage()">
                <option value="en">English</option>
                <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (Hindi)</option>
                <option value="es">Espa√±ol (Spanish)</option>
                <option value="fr">Fran√ßais (French)</option>
            </select>
        </label>
    </div>

    <div class="setting-option">
        <label>
            <input type="checkbox" id="notificationsToggle" onchange="toggleNotifications()" />
            üîî Enable Notifications
        </label>
    </div>

    <div class="setting-option">
        <label>
            <input type="checkbox" id="smsAlertToggle" onchange="toggleSmsAlerts()" />
            üì≤ SMS Alerts for Favorite Routes
        </label>
    </div>

    <div class="setting-option">
        <label>
            <input type="checkbox" id="voiceToggle" onchange="toggleVoiceAnnouncements()" />
            üîä Enable Voice Announcements
        </label>
    </div>

    <div class="setting-option">
        <label>
            <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()" />
            üîÑ Auto-Refresh Bus Data
        </label>
    </div>

    <div class="setting-option">
        <label>
            <input type="checkbox" id="locationTrackingToggle" onchange="toggleLocationTracking()" />
            üìç Enable Location Tracking
        </label>
    </div>

    <div class="setting-option">
        <button class="reset-btn" onclick="resetSettings()">‚ôªÔ∏è Reset to Default</button>
    </div>
</div>
<div class="modal" id="helpModal">
    <button class="close-btn" onclick="closePopup('helpModal')">√ó</button>
    <h2>‚ùì Help & FAQ</h2>
    <div class="help-content">
        <h3>How to Use the Smart Bus Tracker?</h3>
        <p>Our Smart Bus Tracker helps you locate buses in real-time, filter by destination, and track your favorite routes. Simply log in to access all features.</p>
        
        <h3>Frequently Asked Questions</h3>
        <ul>
            <li><strong>Q: How do I track a bus?</strong>
                <p>A: Click on the "Bus Info" button, select a bus, and click "Track" to see its location on the map.</p>
            </li>
            <li><strong>Q: How do I enable SMS alerts?</strong>
                <p>A: Go to "Settings" and enable SMS alerts. You can also configure alerts for your favorite routes.</p>
            </li>
            <li><strong>Q: Can I use voice search?</strong>
                <p>A: Yes! Click on the "üé§ Voice Search" button and say your destination to find buses.</p>
            </li>
            <li><strong>Q: How do I reset my password?</strong>
                <p>A: Click on "Forgot Password" in the login modal and follow the instructions to reset your password.</p>
            </li>
        </ul>
        
        <h3>Contact Us</h3>
        <p>If you have further questions, feel free to reach out to us at <a href="mailto:support@smartbustracker.com">support@smartbustracker.com</a>.</p>
    </div>
</div>

<script>
    // Function to open the Help Modal
    function openHelpModal() {
        openPopup('helpModal');
    }

    // Function to close the Help Modal
    function closeHelpModal() {
        closePopup('helpModal');
    }
</script>

<script>
    const trafficMarkers = {};

    function fetchTrafficUpdatesForBuses() {
        const trafficInfo = document.getElementById('trafficInfo');
        trafficInfo.innerHTML = "Fetching real-time traffic updates for all buses...";

        // Simulate real-time traffic updates for all buses
        setInterval(() => {
            busData.forEach(bus => {
                // Randomly assign traffic status to each bus
                const statuses = ["Heavy Traffic", "Moderate Traffic", "Clear"];
                bus.trafficStatus = statuses[Math.floor(Math.random() * statuses.length)];

                // Update traffic markers on the map
                if (!trafficMarkers[bus.id]) {
                    const marker = L.marker([bus.lat, bus.lon], {
                        icon: L.icon({
                            iconUrl: bus.trafficStatus === "Heavy Traffic"
                                ? "https://cdn-icons-png.flaticon.com/512/190/190406.png"
                                : bus.trafficStatus === "Moderate Traffic"
                                ? "https://cdn-icons-png.flaticon.com/512/190/190411.png"
                                : "https://cdn-icons-png.flaticon.com/512/190/190414.png",
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        })
                    })
                        .addTo(map)
                        .bindPopup(`<strong>Bus ${bus.id}</strong><br>Route: ${bus.start} ‚Üí ${bus.destination}<br>Status: ${bus.trafficStatus}`);
                    trafficMarkers[bus.id] = marker;
                } else {
                    trafficMarkers[bus.id]
                        .setIcon(L.icon({
                            iconUrl: bus.trafficStatus === "Heavy Traffic"
                                ? "https://cdn-icons-png.flaticon.com/512/190/190406.png"
                                : bus.trafficStatus === "Moderate Traffic"
                                ? "https://cdn-icons-png.flaticon.com/512/190/190411.png"
                                : "https://cdn-icons-png.flaticon.com/512/190/190414.png",
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        }))
                        .setPopupContent(`<strong>Bus ${bus.id}</strong><br>Route: ${bus.start} ‚Üí ${bus.destination}<br>Status: ${bus.trafficStatus}`);
                }
            });

            // Update traffic info in the UI
            const updates = busData.map(bus => `<strong>Bus ${bus.id}:</strong> ${bus.trafficStatus}`).join('<br>');
            trafficInfo.innerHTML = updates;
        }, 1000); // Update every 1 second for real-time updates
    }

    document.addEventListener('DOMContentLoaded', () => {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        if (!isLoggedIn) {
            const navButtons = document.querySelector('.nav-buttons');
            const trafficModuleButton = document.createElement('button');
            trafficModuleButton.textContent = "üö¶ Traffic Updates";
            trafficModuleButton.style = "background: var(--primary-color); color: #fff; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;";
            trafficModuleButton.onclick = () => openPopup('trafficUpdatesModal');
            navButtons.appendChild(trafficModuleButton);

            fetchTrafficUpdatesForBuses();
        }
    });
</script>

<!-- Traffic Updates Modal -->
<div class="modal" id="trafficUpdatesModal" style="display: none;">
    <button class="close-btn" onclick="closePopup('trafficUpdatesModal')">√ó</button>
    <h2>üö¶ Real-Time Traffic Updates</h2>
    <p id="trafficInfo">Fetching traffic updates...</p>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script></div>
<script>
const busData = [
    { id: '257', lat: 11.0183, lon: 76.9748, time: '6:30 AM, 8:00 AM, 10:30 AM', start: 'Ondipudur', destination: 'Gandhipuram' },
    { id: '70', lat: 11.0075, lon: 76.9663, time: '7:00 AM, 9:15 AM, 11:45 AM', start: 'Peelamedu', destination: 'Ukkadam' },
    { id: 'S9', lat: 11.0281, lon: 76.9422, time: '6:45 AM, 9:00 AM, 12:30 PM', start: 'Saibaba Colony', destination: 'Gandhipuram' },
    { id: '33C', lat: 11.0125, lon: 76.9600, time: '7:15 AM, 9:45 AM, 1:00 PM', start: 'Kovaipudur', destination: 'Town Hall' },
    { id: '20', lat: 11.0110, lon: 76.9432, time: '6:00 AM, 8:30 AM, 11:00 AM', start: 'Gandhipuram', destination: 'Peelamedu' },
    { id: '6A', lat: 11.0020, lon: 76.9780, time: '7:30 AM, 10:00 AM, 12:30 PM', start: 'Ukkadam', destination: 'RS Puram' },
    { id: '3', lat: 11.0340, lon: 76.9542, time: '6:15 AM, 8:45 AM, 11:15 AM', start: 'Ukkadam', destination: 'Saibaba Colony' },
    { id: '12B', lat: 11.0222, lon: 76.9684, time: '7:00 AM, 9:30 AM, 12:00 PM', start: 'Town Hall', destination: 'Singanallur' },
    { id: '48', lat: 11.0303, lon: 76.9811, time: '6:50 AM, 9:20 AM, 11:50 AM', start: 'Gandhipuram', destination: 'Sundarapuram' },
    { id: '15C', lat: 11.0266, lon: 76.9877, time: '7:10 AM, 9:40 AM, 12:10 PM', start: 'Gandhipuram', destination: 'Ondipudur' },
    { id: '25', lat: 11.0350, lon: 76.9500, time: '6:20 AM, 8:50 AM, 11:20 AM', start: 'Gandhipuram', destination: 'Ganapathy' },
    { id: '10A', lat: 11.0400, lon: 76.9600, time: '7:40 AM, 10:10 AM, 12:40 PM', start: 'Gandhipuram', destination: 'Thudiyalur' },
    { id: '50', lat: 11.0450, lon: 76.9700, time: '6:10 AM, 8:40 AM, 11:10 AM', start: 'Gandhipuram', destination: 'Saravanampatti' },
    { id: '18', lat: 11.0500, lon: 76.9800, time: '7:20 AM, 9:50 AM, 12:20 PM', start: 'Ukkadam', destination: 'Kavundampalayam' },
    { id: '7C', lat: 11.0550, lon: 76.9900, time: '6:35 AM, 9:05 AM, 11:35 AM', start: 'Town Hall', destination: 'Vadavalli' },
    { id: '22B', lat: 11.0600, lon: 77.0000, time: '7:05 AM, 9:35 AM, 12:05 PM', start: 'Ukkadam', destination: 'Perur' },
    { id: '9', lat: 11.0650, lon: 77.0100, time: '6:25 AM, 8:55 AM, 11:25 AM', start: 'Gandhipuram', destination: 'Kuniamuthur' },
    { id: '16A', lat: 11.0700, lon: 77.0200, time: '7:15 AM, 9:45 AM, 12:15 PM', start: 'Ukkadam', destination: 'Singanallur' },
    { id: '5', lat: 11.0750, lon: 77.0300, time: '6:45 AM, 9:15 AM, 11:45 AM', start: 'Town Hall', destination: 'Sulur' },
    { id: '14', lat: 11.0800, lon: 77.0400, time: '7:25 AM, 9:55 AM, 12:25 PM', start: 'Gandhipuram', destination: 'Kaniyur' },
    { id: '102', lat: 10.9300, lon: 76.9650, time: '6:00 AM, 8:45 AM, 1:00 PM', start: 'Pollachi', destination: 'Kinathukidavu' },
    { id: '103A', lat: 10.9900, lon: 76.9500, time: '7:30 AM, 10:00 AM, 3:00 PM', start: 'Gandhipuram', destination: 'Kinathukidavu' },
    { id: '104B', lat: 11.0000, lon: 76.9400, time: '8:00 AM, 12:00 PM, 5:30 PM', start: 'Ukkadam', destination: 'Kinathukidavu' },
    { id: '105C', lat: 11.0150, lon: 76.9650, time: '9:00 AM, 1:30 PM, 6:30 PM', start: 'Town Hall', destination: 'Kinathukidavu' }
];
let simulationData = [];
let simulationInterval = null;
let busMarkers = {};

function initMap() {
  map = L.map('map').setView([11.0168, 76.9558], 12); // Coimbatore center

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  loadBuses(busData);
}

function loadBuses(data) {
  data.forEach(bus => {
    const position = [bus.lat, bus.lon];
    if (!busMarkers[bus.id]) {
      const marker = L.marker(position)
        .addTo(map)
        .bindPopup(`<strong>Bus ${bus.id}</strong><br>${bus.start} ‚Üí ${bus.destination}<br>Timings: ${bus.time}`);
      busMarkers[bus.id] = marker;
    } else {
      busMarkers[bus.id].setLatLng(position);
    }
  });
}

function startSimulation() {
  if (simulationInterval) {
    alert("Simulation is already running!");
    return;
  }

  simulationData = JSON.parse(JSON.stringify(busData)); // Copy current bus data

  simulationInterval = setInterval(() => {
    simulationData.forEach(bus => {
      const latShift = (Math.random() - 0.5) * 0.001;
      const lonShift = (Math.random() - 0.5) * 0.001;
      bus.lat += latShift;
      bus.lon += lonShift;
    });

    loadBuses(simulationData);
  }, 2000); // update every 2 seconds

  alert("Simulation started!");
}

function stopSimulation() {
  if (!simulationInterval) {
    alert("No simulation is running!");
    return;
  }

  clearInterval(simulationInterval);
  simulationInterval = null;
  alert("Simulation stopped!");
}

function resetSimulation() {
  if (simulationInterval) {
    clearInterval(simulationInterval);
    simulationInterval = null;
  }

  simulationData = JSON.parse(JSON.stringify(initialBusData));
  loadBuses(simulationData);
  alert("Simulation reset!");
}

// Call initMap() on window load or after DOM is ready
window.onload = initMap;

const initialBusData = JSON.parse(JSON.stringify(busData));
const map = L.map('map').setView([11.0168, 76.9558], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let markers = [];

// Ensure loadBuses function is defined and used consistently

function showModal() { 
    document.getElementById('busModal').classList.add('show'); 
    populateTable(); // Ensure table is populated when modal is shown
    logEvent('Opened Bus Info Modal');
}
function hideModal() { 
    document.getElementById('busModal').classList.remove('show'); 
    logEvent('Closed Bus Info Modal');
}
function showSms() { 
    document.getElementById('smsNotification').classList.add('show'); 
    logEvent('Opened SMS Notification Modal');
}
function showHistory() { 
    loadHistory(); 
    document.getElementById('historyModal').classList.add('show'); 
    logEvent('Opened Notification History Modal');
}
function closePopup(id) { 
    document.getElementById(id).classList.remove('show'); 
    logEvent(`Closed Modal with ID: ${id}`);
}
function populateTable(filteredBuses = busData) {
    const table = document.getElementById('busTable');
    table.innerHTML = ''; // Clear existing rows

    if (filteredBuses.length === 0) {
        table.innerHTML = '<tr><td colspan="5">No buses found</td></tr>';
    } else {
        const busesByDestination = filteredBuses.reduce((acc, bus) => {
            if (!acc[bus.destination]) {
                acc[bus.destination] = [];
            }
            acc[bus.destination].push(bus);
            return acc;
        }, {});

        Object.keys(busesByDestination).forEach(destination => {
            const destinationRow = `<tr><td colspan="5" style="font-weight: bold; text-align: center; ">${destination}</td></tr>`;
            table.innerHTML += destinationRow;

            busesByDestination[destination].forEach(bus => {
                const row = `
                    <tr>
                        <td>${bus.id}</td>
                        <td>${bus.start}</td>
                        <td>${bus.destination}</td>
                        <td>${bus.time}</td>
                        <td><button onclick="addTracking('${bus.id}')">Track</button></td>
                    </tr>`;
                table.innerHTML += row;
            });
        });
    }

    const destFilter = document.getElementById('destination-filter');
    const uniqueDestinations = [...new Set(busData.map(b => b.destination))];
    destFilter.innerHTML = '<option value="">All</option>'; // Clear existing options
    uniqueDestinations.forEach(d => {
        if (!Array.from(destFilter.options).some(option => option.value === d)) {
            destFilter.innerHTML += `<option value="${d}">${d}</option>`;
        }
    });
    logEvent('Filtered destinations and updated dropdown to include "All" option');
}

function addTracking(busId) {
    const bus = busData.find(b => b.id === busId);
    if (!bus) {
        alert(`Bus with ID ${busId} not found.`);
        logEvent(`Tracking failed: Bus ID ${busId} not found`);
        return;
    }

    const marker = L.marker([bus.lat, bus.lon], { icon: L.icon({
        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
        shadowSize: [41, 41]
    }) }).addTo(map).bindPopup(`üöå <strong>Tracking Bus ${bus.id}</strong><br><strong>Route:</strong> ${bus.start} ‚Üí ${bus.destination}<br><strong>Timings:</strong> ${bus.time}`).openPopup();

    map.setView([bus.lat, bus.lon], 14);
    logEvent(`Started tracking Bus ID: ${busId}`);
}

function filterByDestination(dest) {
    if (!dest) return;
    document.getElementById('busModal').classList.add('show');
    const filtered = busData.filter(bus => bus.destination === dest);
    populateTable(filtered);
    logEvent(`Filtered buses by destination: ${dest}`);
}


function populateDropdown() {
    const destinations = [...new Set(busData.map(b => b.destination))].sort();
    const dropdown = document.getElementById('destination-filter');
    dropdown.innerHTML = '<option value="">All</option>'; // Clear existing options
    destinations.forEach(dest => {
        if (!Array.from(dropdown.options).some(option => option.value === dest)) {
            const option = document.createElement('option');
            option.value = dest;
            option.textContent = dest;
            dropdown.appendChild(option);
        }
    });
    logEvent('Populated destination dropdown');
}

const locationTrackingControl = L.control({ position: 'bottomright' });
locationTrackingControl.onAdd = function () {
    const div = L.DomUtil.create('div', 'location-tracking-container');
    div.innerHTML = ``;
    L.DomEvent.disableClickPropagation(div);
    return div;
};
locationTrackingControl.addTo(map);

const dropdown = L.control({ position: 'topright' });
dropdown.onAdd = function () {
    const div = L.DomUtil.create('div', 'destination-dropdown');
    div.innerHTML = ``;
    return div;
};
dropdown.addTo(map);
populateDropdown();

function enableSmsNotification(e) {
    e.preventDefault();
    const phone = document.getElementById('phoneNumber').value;
    if (!phone) return alert('Enter a valid phone number!');
    const msg = `Alerts enabled for ${phone}`;
    alert(msg);
    saveToHistory(msg);
    closePopup('smsNotification');
    logEvent(`Enabled SMS Notification for Phone: ${phone}`);
}

const historyKey = 'busTrackerHistory';
function saveToHistory(entry) {
    const history = JSON.parse(localStorage.getItem(historyKey)) || [];
    history.push({ entry, timestamp: new Date().toLocaleString() });
    localStorage.setItem(historyKey, JSON.stringify(history));
    logEvent(`Saved to History: ${entry}`);
}

function loadHistory() {
    const history = JSON.parse(localStorage.getItem(historyKey)) || [];
    const list = document.getElementById('historyList');
    list.innerHTML = '';
    history.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.timestamp} - ${item.entry}`;
        list.appendChild(li);
    });
    logEvent('Loaded Notification History');
}
function trackLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
            const { latitude, longitude } = pos.coords;
            document.getElementById('location-status-1').innerHTML = `<strong>Lat:</strong> ${latitude.toFixed(4)}, <strong>Lon:</strong> ${longitude.toFixed(4)}`;

            // Fetch the full address using a reverse geocoding API
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                if (!response.ok) throw new Error('Failed to fetch address');
                const data = await response.json();
                const address = data.display_name || 'Unknown Location';

                const locationStatus = document.getElementById('location-status-1');
                if (!locationStatus.dataset.addressDisplayed) {
                    locationStatus.innerHTML += `<br><strong>Address:</strong> ${address}`;
                    locationStatus.dataset.addressDisplayed = "true"; // Mark as displayed
                }

                const userMarker = L.marker([latitude, longitude], { icon: L.icon({
                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
                    shadowSize: [41, 41]
                }) }).addTo(map).bindPopup(`üìç <strong>You are here</strong><br>${address}`).openPopup();
                map.setView([latitude, longitude], 14);
                logEvent(`Tracked Location: Lat ${latitude.toFixed(4)}, Lon ${longitude.toFixed(4)}, Address: ${address}`);
            } catch (error) {
                const locationStatus = document.getElementById('location-status-1');
                if (!locationStatus.dataset.addressDisplayed) {
                    locationStatus.innerHTML += `<br><strong>Address:</strong> Unable to fetch address`;
                    locationStatus.dataset.addressDisplayed = "true"; // Mark as displayed
                }
                console.error('Error fetching address:', error);
                logEvent('Failed to fetch address');
            }
        }, err => {
            const errorMessage = err.code === 1 ? 'Location access denied.' : 'Unable to retrieve location.';
            document.getElementById('location-status-1').textContent = errorMessage;
            logEvent(errorMessage);
        });
    } else {
        document.getElementById('location-status-1').textContent = 'Geolocation not supported by your browser.';
        logEvent('Geolocation not supported');
    }
}
const eventLogKey = 'eventLog';
function logEvent(event) {
    const logs = JSON.parse(localStorage.getItem(eventLogKey)) || [];
    logs.push({ event, timestamp: new Date().toLocaleString() });
    localStorage.setItem(eventLogKey, JSON.stringify(logs));
    console.log(`Event Logged: ${event}`);
}

function loadBuses(filteredBuses = busData) {
    // Remove existing markers from the map
    Object.values(busMarkers).forEach(marker => map.removeLayer(marker));
    busMarkers = {};

    // Add new markers for the filtered buses
    filteredBuses.forEach(bus => {
        const marker = L.marker([bus.lat, bus.lon])
            .addTo(map)
            .bindPopup(`üöå <strong>Bus ${bus.id}</strong><br><strong>Route:</strong> ${bus.start} ‚Üí ${bus.destination}<br><strong>Timings:</strong> ${bus.time}`);
        busMarkers[bus.id] = marker;
    });

    // Adjust the map view to fit the markers if any buses are displayed
    const markerPositions = Object.values(busMarkers).map(marker => marker.getLatLng());
    if (markerPositions.length > 0) {
        const bounds = L.latLngBounds(markerPositions);
        map.fitBounds(bounds.pad(0.1));
    } else {
        map.setView([11.0168, 76.9558], 12); // Reset to default view if no buses are displayed
    }

    // Update the table with the filtered buses
    populateTable(filteredBuses);

    // Log the event
    logEvent(`Loaded ${filteredBuses.length} buses on the map`);
}

// Initial load of all buses
loadBuses();
</script>

<script>
const usersKey = 'registeredUsers';

function toggleLoginPasswordVisibility() {
    const pwd = document.getElementById('loginPassword');
    pwd.type = document.getElementById('showLoginPasswordToggle').checked ? 'text' : 'password';
}

function toggleRegisterPasswordVisibility() {
    const pwd = document.getElementById('registerPassword');
    const confirm = document.getElementById('registerConfirmPassword');
    const show = document.getElementById('showRegisterPasswordToggle').checked;
    pwd.type = confirm.type = show ? 'text' : 'password';
}
function sendVerificationCode() {
    const nameInput = document.getElementById('registerName');
    const phoneInput = document.getElementById('registerPhone');
    const emailInput = document.getElementById('registerEmail');
    const passwordInput = document.getElementById('registerPassword');
    const confirmPasswordInput = document.getElementById('registerConfirmPassword');
    const verificationSection = document.getElementById('verificationSection');

    if (!nameInput || !phoneInput || !emailInput || !passwordInput || !confirmPasswordInput || !verificationSection) {
        console.error("One or more required input elements are missing in the DOM.");
        return;
    }

    const name = nameInput.value.trim();
    const phone = phoneInput.value.trim();
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const confirmPassword = confirmPasswordInput.value.trim();

    // Validate all fields
    if (!name || !phone || !email || !password || !confirmPassword) {
        alert("Please fill in all fields.");
        return;
    }

    // Validate phone number and email format
    const phoneRegex = /^\d{10}$/;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    if (!phoneRegex.test(phone)) {
        alert("Please enter a valid 10-digit phone number.");
        return;
    }

    if (!emailRegex.test(email)) {
        alert("Please enter a valid email address.");
        return;
    }

    // Validate password strength
    if (password.length < 8 || !/[A-Z]/.test(password) || !/[a-z]/.test(password) || !/[0-9]/.test(password) || !/[!@#$%^&*]/.test(password)) {
        alert("Password must be at least 8 characters long and include uppercase, lowercase, number, and special character.");
        return;
    }

    // Validate password confirmation
    if (password !== confirmPassword) {
        alert("Passwords do not match.");
        return;
    }

    // Show the OTP section if validations pass
    verificationSection.style.display = 'block';

    const code = Math.floor(100000 + Math.random() * 900000).toString();
    localStorage.setItem('verificationCode', code);

    // Display the verification code in a popup modal
    const popup = document.createElement('div');
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.backgroundColor = '#add8e6'; // Changed background color to LightBlue
    popup.style.padding = '20px';
    popup.style.borderRadius = '10px';
    popup.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
    popup.style.zIndex = '1000';
    popup.innerHTML = `
        <p style="font-size: 1.2rem; margin-bottom: 10px;">Your verification code is:</p>
        <p style="font-size: 1.5rem; font-weight: bold; margin-bottom: 20px;">${code}</p>
        <button style="padding: 10px 20px; background-color: #4caf50; color: #fff; border: none; border-radius: 5px; cursor: pointer;" onclick="document.body.removeChild(this.parentElement)">OK</button>
        <button style="padding: 10px 20px; background-color: #2196f3; color: #fff; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;" onclick="speakOtp('${code}')">üîä Speak OTP</button>
    `;
    document.body.appendChild(popup);
}
function speakOtp(otp) {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(`Your verification code is ${otp}`);
        window.speechSynthesis.speak(utterance);
    } else {
        alert('Speech synthesis is not supported in this browser.');
    }
} // Closing the speakOtp function
function handleRegister(event) {
    event.preventDefault();
    const name = document.getElementById('registerName').value.trim();
    const phone = document.getElementById('registerPhone').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const pwd = document.getElementById('registerPassword').value.trim();
    const confirm = document.getElementById('registerConfirmPassword').value.trim();
    const code = document.getElementById('verificationCode').value.trim();
    const storedCode = localStorage.getItem('verificationCode');

    const error = document.getElementById('registerError');
    const success = document.getElementById('registerMsg');
    error.style.display = success.style.display = 'none';

    // Helper function for displaying error messages
    const showError = (message) => {
        error.textContent = message;
        error.style.display = 'block';
    };

    // Input validation
    if (!name || !phone || !email || !pwd || !confirm || !code) {
        showError("Please fill in all fields.");
        return;
    }

    if (!/^[a-zA-Z\s]+$/.test(name)) {
        showError("Name can only contain letters and spaces.");
        return;
    }

    if (!/^\d{10}$/.test(phone)) {
        showError("Phone number must be 10 digits.");
        return;
    }

    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showError("Invalid email format.");
        return;
    }

    if (pwd.length < 8 || !/[A-Z]/.test(pwd) || !/[a-z]/.test(pwd) || !/[0-9]/.test(pwd) || !/[!@#$%^&*]/.test(pwd)) {
        showError("Password must be at least 8 characters long and include uppercase, lowercase, number, and special character.");
        return;
    }

    if (pwd !== confirm) {
        showError("Passwords do not match.");
        return;
    }

    if (code !== storedCode) {
        showError("Invalid verification code.");
        return;
    }

    const users = JSON.parse(localStorage.getItem(usersKey)) || [];
    if (users.some(u => u.email === email || u.phone === phone)) {
        showError("User already registered with this email or phone number.");
        return;
    }

    // Create new user object with advanced features
    const newUser = {
        name,
        phone,
        email,
        password: pwd,
        smsAlerts: false,
        profilePic: 'https://via.placeholder.com/100',
        createdAt: new Date().toISOString(),
        preferences: {
            darkMode: false,
            notifications: false,
            language: 'en',
            voiceAnnouncements: false,
            autoRefresh: false,
            locationTracking: false
        },
        activityLog: [],
        lastLogin: null,
        securityQuestions: [],
        favorites: [],
        recentSearches: []
    };

    // Log registration activity
    newUser.activityLog.push({
        action: "Registration",
        timestamp: new Date().toLocaleString(),
        details: "User registered successfully."
    });

    // Save user to localStorage
    users.push(newUser);
    localStorage.setItem(usersKey, JSON.stringify(users));

    // Display success message
    success.textContent = "Registration successful! Please log in.";
    success.style.display = 'block';
    showAlert("Registration successful!");

    // Clear verification code from localStorage
    localStorage.removeItem('verificationCode');

    // Automatically log the user in after registration
    localStorage.setItem('isLoggedIn', 'true');
    localStorage.setItem('currentUser', JSON.stringify(newUser));

    // Log automatic login activity
    newUser.activityLog.push({
        action: "Auto Login",
        timestamp: new Date().toLocaleString(),
        details: "User automatically logged in after registration."
    });

    // Save user preferences and settings
    localStorage.setItem('userPreferences', JSON.stringify(newUser.preferences));

    // Redirect to the homepage after a short delay
    setTimeout(() => {
        closePopup('registerModal'); // Close the registration modal
        setTimeout(() => {
            window.location.href = 'index.html'; // Redirect to homepage
        }, 2000); // Delay for 2 seconds before redirecting
    }, 2000);
}

function getGravatarUrl(email) {
  const hash = CryptoJS.MD5(email.trim().toLowerCase()).toString();
  return `https://www.gravatar.com/avatar/${hash}?s=100&d=identicon`;
}

function zxcvbnScore(pw) {
  // quick entropy estimate (0‚Äë4)
  let score = 0;
  if (pw.length >= 8) score++;
  if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) score++;
  if (/\d/.test(pw)) score++;
  if (/[!@#$%^&*]/.test(pw)) score++;
  return score;
}

document.getElementById("registerPassword").addEventListener("input", e => {
  const meter = document.getElementById("pwMeter");
  const pw = e.target.value;
  const score = zxcvbnScore(pw);
  meter.value = score;
});

function handleLogin(event) {
    event.preventDefault();
    const id = document.getElementById('loginEmail').value.trim();
    const pwd = document.getElementById('loginPassword').value.trim();
    const error = document.getElementById('loginError');
    error.style.display = 'none';

    const users = JSON.parse(localStorage.getItem(usersKey)) || [];
    const user = users.find(u => (u.email === id || u.phone === id) && u.password === pwd);

    if (user) {
        // Check for account lock due to multiple failed attempts
        if (user.failedAttempts && user.failedAttempts >= 3) {
            const lockDuration = 5 * 60 * 1000; // 5 minutes
            const timeSinceLastAttempt = new Date() - new Date(user.lastFailedAttempt);
            if (timeSinceLastAttempt < lockDuration) {
                const remainingTime = Math.ceil((lockDuration - timeSinceLastAttempt) / 1000 / 60);
                error.textContent = `Account locked. Try again in ${remainingTime} minutes.`;
                error.style.display = 'block';
                return;
            } else {
                // Reset failed attempts after lock duration
                user.failedAttempts = 0;
                delete user.lastFailedAttempt;
            }
        }

        localStorage.setItem('isLoggedIn', 'true');
        localStorage.setItem('currentUser', JSON.stringify(user));

        // Log login activity
        user.activityLog = user.activityLog || [];
        user.activityLog.push({
            action: "Login",
            timestamp: new Date().toLocaleString(),
            details: "User logged in successfully."
        });
        localStorage.setItem(usersKey, JSON.stringify(users));

        // Update last login timestamp
        user.lastLogin = new Date().toISOString();
        localStorage.setItem(usersKey, JSON.stringify(users));
        const loginModal = document.getElementById('loginModal');
        const welcomeMessage = document.createElement('div');
        welcomeMessage.style.position = 'fixed';
        welcomeMessage.style.top = '10px';
        welcomeMessage.style.left = '50%';
        welcomeMessage.style.transform = 'translateX(-50%)';
        welcomeMessage.style.background = '#4caf50';
        welcomeMessage.style.color = 'white';
        welcomeMessage.style.padding = '10px 20px';
        welcomeMessage.style.borderRadius = '5px';
        welcomeMessage.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
        welcomeMessage.style.zIndex = '1000';
        welcomeMessage.style.cursor = 'pointer';
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const userName = currentUser?.name || 'User';
        welcomeMessage.textContent = `Welcome back, ${userName}!`;

        // Make the message draggable
        welcomeMessage.onmousedown = function (event) {
            let shiftX = event.clientX - welcomeMessage.getBoundingClientRect().left;
            let shiftY = event.clientY - welcomeMessage.getBoundingClientRect().top;

            function moveAt(pageX, pageY) {
                welcomeMessage.style.left = pageX - shiftX + 'px';
                welcomeMessage.style.top = pageY - shiftY + 'px';
            }

            function onMouseMove(event) {
                moveAt(event.pageX, event.pageY);
            }

            document.addEventListener('mousemove', onMouseMove);

            welcomeMessage.onmouseup = function () {
                document.removeEventListener('mousemove', onMouseMove);
                welcomeMessage.onmouseup = null;
            };
        };

        welcomeMessage.ondragstart = function () {
            return false;
        };

        loginModal.appendChild(welcomeMessage);
        setTimeout(() => {
            window.location.href = 'index.html';
        }, 2000); // Delay for 2 seconds before redirecting
    } else {
        // Handle failed login attempts
        const failedUser = users.find(u => u.email === id || u.phone === id);
        if (failedUser) {
            failedUser.failedAttempts = (failedUser.failedAttempts || 0) + 1;
            failedUser.lastFailedAttempt = new Date().toISOString();
            localStorage.setItem(usersKey, JSON.stringify(users));

            if (failedUser.failedAttempts >= 3) {
                error.textContent = "Account locked due to multiple failed attempts. Try again in 5 minutes.";
            } else {
                const remainingAttempts = 3 - failedUser.failedAttempts;
                error.textContent = `Invalid credentials. You have ${remainingAttempts} attempt(s) left.`;
            }
        } else {
            error.textContent = "Invalid email or password.";
        }
        error.style.display = 'block';
        showAlert("Login failed. Please check your credentials.");
    }

    // Additional security: Log failed login attempts
    logEvent(`Login attempt for ID: ${id} ${user ? 'succeeded' : 'failed'}`);
}

function saveProfile(event) {
    event.preventDefault();
    const name = document.getElementById('profileName').value.trim();
    const phone = document.getElementById('profilePhone').value.trim();
    const smsAlerts = document.getElementById('smsToggle').checked;
    const bio = document.getElementById('profileBio').value.trim();

    const users = JSON.parse(localStorage.getItem(usersKey)) || [];
    let currentUser = JSON.parse(localStorage.getItem('currentUser'));

    const updatedUsers = users.map(u => {
        if (u.email === currentUser.email) {
            return { ...u, name, phone, smsAlerts, bio };
        }
        return u;
    });

    localStorage.setItem(usersKey, JSON.stringify(updatedUsers));
    currentUser = { ...currentUser, name, phone, smsAlerts, bio };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));

    const msg = document.getElementById('profileMsg');
    msg.style.display = 'block';
    setTimeout(() => {
        msg.style.display = 'none';
        closePopup('profileModal');
    }, 1500);

    // Update profile picture in the navbar and dropdown
    const profileImage = document.getElementById('profileImage');
    const dropdownProfileImage = document.getElementById('dropdownProfileImage');
    profileImage.src = currentUser.profilePic || 'https://via.placeholder.com/60';
    dropdownProfileImage.src = currentUser.profilePic || 'https://via.placeholder.com/100';

    // Update name in the dropdown
    const dropdownName = document.querySelector('.dropdown-name');
    if (dropdownName) {
        dropdownName.textContent = `üë§ ${currentUser.name || 'User'}`;
    }

    // Update email in the dropdown
    const dropdownEmail = document.querySelector('.dropdown-email');
    if (dropdownEmail) {
        dropdownEmail.textContent = `üìß ${currentUser.email || 'N/A'}`;
    }

    // Log profile update activity
    currentUser.activityLog = currentUser.activityLog || [];
    currentUser.activityLog.push({
        action: "Profile Update",
        timestamp: new Date().toLocaleString(),
        details: "User updated their profile information."
    });
    localStorage.setItem('currentUser', JSON.stringify(currentUser));

    // Update bio in the profile modal
    const profileBio = document.getElementById('profileBio');
    if (profileBio) {
        profileBio.value = currentUser.bio || '';
    }

    // Notify user of successful update
    alert("Profile updated successfully!");
}

// Function to open modals
function openPopup(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('show');  // Add show class to display the modal
    }
}

// Function to close modals
function closePopup(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');  // Remove show class to hide the modal
    }
}

// Helper function to reset error and success messages on modal close
function resetMessages() {
    const loginError = document.getElementById('loginError');
    const registerError = document.getElementById('registerError');
    const forgotPasswordError = document.getElementById('forgotPasswordError');
    const registerMsg = document.getElementById('registerMsg');
    const forgotPasswordMsg = document.getElementById('forgotPasswordMsg');

    loginError.style.display = 'none';
    registerError.style.display = 'none';
    forgotPasswordError.style.display = 'none';
    registerMsg.style.display = 'none';
    forgotPasswordMsg.style.display = 'none';
}

// Add event listeners to reset messages when modals are closed
document.getElementById('loginModal').addEventListener('click', resetMessages);
document.getElementById('registerModal').addEventListener('click', resetMessages);
document.getElementById('forgotPasswordModal').addEventListener('click', resetMessages);

// Function to display an alert
function showAlert(message) {
    alert(message);
}

function logout() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('currentUser');
    showAlert("Logged out!");
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 2000); // Delay for 2 seconds before redirecting
    localStorage.removeItem('currentUser');
    showAlert("Logged out!");
    setTimeout(() => {
        window.location.href = 'index.html';
    }, 2000); // Delay for 2 seconds before redirecting
}

function clearUserData() {
    localStorage.removeItem('registeredUsers');
    localStorage.removeItem('userPreferences');
    localStorage.removeItem('eventLog');
    localStorage.removeItem('busTrackerHistory');
    localStorage.removeItem('verificationCode');
    localStorage.removeItem('currentUser');
    showAlert("All user data cleared!");
}

function resetApp() {
    clearUserData();
    localStorage.clear();
    showAlert("Application reset to default settings!");
    setTimeout(() => {
    }, 2000); // Delay for 2 seconds before redirecting
}

function clearFeedbackHistory() {
    localStorage.removeItem('userFeedback');
    showAlert("Feedback history cleared!");
}

function clearSimulationData() {
    simulationData = [];
    if (simulationInterval) {
        clearInterval(simulationInterval);
        simulationInterval = null;
    }
    loadBuses(busData); // Reset to initial bus data
    showAlert("Simulation data cleared!");
}


function showAlert(message) {
    const alertBox = document.createElement('div');
    alertBox.textContent = message;
    alertBox.style.position = 'fixed';
    alertBox.style.bottom = '20px';
    alertBox.style.right = '20px';
    alertBox.style.backgroundColor = '#4caf50';
    alertBox.style.color = 'white';
    alertBox.style.padding = '10px 20px';
    alertBox.style.borderRadius = '5px';
    alertBox.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.2)';
    alertBox.style.zIndex = '1000';
    document.body.appendChild(alertBox);

    setTimeout(() => {
        alertBox.remove();
    }, 3000);
}
document.addEventListener('DOMContentLoaded', () => {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    const restrictedElements = [
        document.getElementById('map'),
        document.querySelector('.location-tracking-container'),
        document.querySelector('.destination-filter-container'),
        document.querySelector('.voice-search-container')
    ];

    restrictedElements.forEach(element => {
        if (element) {
            element.style.display = isLoggedIn ? 'block' : 'none';
        }
    });
restrictedElements.forEach(element => {
    if (element) {
    element.style.display = isLoggedIn ? 'block' : 'none';
    }
});

const dropdownMenu = document.getElementById('dropdownMenu');
if (!isLoggedIn && dropdownMenu) {
    dropdownMenu.innerHTML = `
    <button onclick="openPopup('loginModal')" style="display: block; width: 100%; margin-bottom: 5px;">üîë Login</button>
    <button onclick="openPopup('registerModal')" style="display: block; width: 100%;">üìù Register</button>
    `;
}
});

function toggleLocationTracking() {
    const locationToggle = document.getElementById('locationTrackingToggle');
    const locationStatus = document.getElementById('location-status-1');

    if (locationToggle.checked) {
        if (navigator.geolocation) {
            alert("Location tracking enabled.");
            logEvent("Location tracking enabled.");
            trackLocation(); // Start tracking location
        } else {
            alert("Location tracking is not supported by your browser.");
            logEvent("Location tracking not supported.");
            locationStatus.textContent = "Location tracking is not supported.";
            locationToggle.checked = false; // Automatically disable toggle
        }
    } else {
        alert("Location tracking disabled.");
        logEvent("Location tracking disabled.");
        locationStatus.textContent = "Location tracking is disabled.";
    }
}
</script>
<script>
    const dailyFeedTips = [
        "üí° Tip: Stay hydrated and take public transport to reduce your carbon footprint!",
        "üå± Eco Tip: Walking short distances saves fuel and keeps you healthy.",
        "üöç Travel Smart: Always check the bus ETA and route before you leave.",
        "üòé Stay Safe: Wear a hat and sunglasses during peak sun hours.",
        "üì± Tech Tip: Bookmark your favorite bus routes for quick access.",
        "üåßÔ∏è Weather Alert: Carry an umbrella if there's a chance of rain today.",
        "üåá Evening Note: Buses might be crowded during rush hour‚Äîplan accordingly.",
        "üéß Commuter Tip: Listen to audiobooks or podcasts while commuting!",
        "üïí Time Saver: Use the traffic simulation to plan the fastest route.",
        "üîã Energy Tip: Dim your phone brightness to save battery while traveling.",
        "üö¶ Safety Tip: Always use pedestrian crossings and follow traffic signals.",
        "üß£ Weather Tip: It might get chilly in the evening‚Äîcarry a light jacket!",
        "üåç Green Living: Carpool or take the bus to help reduce city pollution.",
        "üßò‚Äç‚ôÄÔ∏è Wellness Tip: Deep breathing or meditation can ease commute stress.",
        "üöå Route Reminder: Check for route diversions or maintenance alerts.",
        "üîî Heads up: Enable SMS alerts for your favorite routes to stay updated.",
        "üì∏ Fun Idea: Share a cool photo from your commute using #SmartBusCoimbatore!",
        "üö´ Lost something? Use the feedback section to report lost & found items.",
        "üìä Tracker Tip: Monitor live bus movement and plan like a pro.",
        "üåû Morning Boost: A good breakfast keeps your energy up during travel!"
    ];

    document.addEventListener('DOMContentLoaded', () => {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const dailyFeed = document.getElementById('dailyFeed');
        const feedbackSection = document.getElementById('feedbackSection');

        if (!isLoggedIn) {
            dailyFeed.style.display = 'block';
            feedbackSection.style.display = 'block';
            fetchWeather();
            showRandomTip();
        } else {
            dailyFeed.style.display = 'none';
            feedbackSection.style.display = 'none';
        }
    });

    function fetchWeather() {
        const weatherInfo = document.getElementById('weatherInfo');
        fetch('https://api.open-meteo.com/v1/forecast?latitude=11.0168&longitude=76.9558&current_weather=true')
            .then(response => response.json())
            .then(data => {
                const weather = data.current_weather;
                const temp = weather.temperature;
                const code = weather.weathercode;
                const condition = getWeatherCondition(code);
                weatherInfo.textContent = `Current Weather: ${temp}¬∞C, ${condition}`;
            })
            .catch(() => {
                weatherInfo.textContent = 'Unable to fetch weather information.';
            });
    }

    function getWeatherCondition(code) {
        const conditions = {
            0: "Clear sky",
            1: "Mainly clear",
            2: "Partly cloudy",
            3: "Overcast",
            45: "Fog",
            48: "Depositing rime fog",
            51: "Light drizzle",
            53: "Moderate drizzle",
            55: "Dense drizzle",
            61: "Light rain",
            63: "Moderate rain",
            65: "Heavy rain",
            80: "Rain showers",
            95: "Thunderstorm",
            99: "Heavy thunderstorm"
        };
        return conditions[code] || "Unknown weather";
    }

    function showRandomTip() {
        const tipElement = document.getElementById('dailyTips');
        const randomTip = dailyFeedTips[Math.floor(Math.random() * dailyFeedTips.length)];
        tipElement.textContent = randomTip;
    }

    function submitFeedback(event) {
        event.preventDefault();
        const feedbackInput = document.getElementById('feedbackInput');
        const feedbackMessage = document.getElementById('feedbackMessage');

        if (feedbackInput.value.trim()) {
            feedbackMessage.style.display = 'block';
            feedbackInput.value = '';
            setTimeout(() => {
                feedbackMessage.style.display = 'none';
            }, 3000);
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

    const loggedOutOnlyContent = document.getElementById('loggedOutOnlyContent');
    if (loggedOutOnlyContent) {
        loggedOutOnlyContent.style.display = isLoggedIn ? 'none' : 'block';
    }

    // You can still load feedback if needed
    if (!isLoggedIn) {
        loadFeedbackHistory();
    }
});
document.addEventListener('DOMContentLoaded', () => {
  const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
  const filterSection = document.getElementById('filterSection');
  
  // Show the filter bar only if the user is logged in
  if (isLoggedIn && filterSection) {
    filterSection.style.display = 'block';
  } else {
    filterSection.style.display = 'none';
  }
});

</script>
<script>
    function resetSettings() {
        // Reset all checkboxes and settings to default
        document.getElementById("darkModeToggle").checked = false;
        document.getElementById("voiceToggle").checked = false;
        document.getElementById("notificationsToggle").checked = false;
        document.getElementById("smsAlertToggle").checked = false;
        document.getElementById("autoRefreshToggle").checked = false;
        document.getElementById("locationTrackingToggle").checked = false;
        document.getElementById("languageSelect").value = "en"; // Default language is English

        // Clear localStorage for all settings
        localStorage.removeItem("darkMode");
        localStorage.removeItem("voiceAnnouncements");
        localStorage.removeItem("notificationsEnabled");
        localStorage.removeItem("smsAlertsEnabled");
        localStorage.removeItem("autoRefresh");
        localStorage.removeItem("locationTrackingEnabled");
        localStorage.removeItem("language");

        speak("Settings have been reset to default.");
    }
    // Function to open the modal
    function openPopup(id) {
        document.getElementById(id).style.display = "block";
    }

    // Function to close the modal
    function closePopup(id) {
        document.getElementById(id).style.display = "none";
    }

    // Function to load saved settings from localStorage
    window.onload = function () {
        // Load settings from localStorage
        const darkMode = localStorage.getItem("darkMode") === "true";
        const voiceEnabled = localStorage.getItem("voiceAnnouncements") === "true";
        const notificationsEnabled = localStorage.getItem("notificationsEnabled") === "true";
        const smsAlertsEnabled = localStorage.getItem("smsAlertsEnabled") === "true";
        const autoRefresh = localStorage.getItem("autoRefresh") === "true";
        const locationTrackingEnabled = localStorage.getItem("locationTrackingEnabled") === "true";
        const selectedLanguage = localStorage.getItem("language") || "en";

        // Apply saved settings
        document.getElementById("darkModeToggle").checked = darkMode;
        document.getElementById("voiceToggle").checked = voiceEnabled;
        document.getElementById("notificationsToggle").checked = notificationsEnabled;
        document.getElementById("smsAlertToggle").checked = smsAlertsEnabled;
        document.getElementById("autoRefreshToggle").checked = autoRefresh;
        document.getElementById("locationTrackingToggle").checked = locationTrackingEnabled;
        document.getElementById("languageSelect").value = selectedLanguage;
    }
    // Additional functionality can be added here if needed
    function toggleDarkMode() {
        const isDarkMode = document.getElementById("darkModeToggle").checked;
        if (isDarkMode) {
            document.body.classList.add("dark-mode");
            localStorage.setItem("darkMode", "true");
        } else {
            document.body.classList.remove("dark-mode");
            localStorage.setItem("darkMode", "false");
        }
    }

    function changeLanguage() {
        const selectedLanguage = document.getElementById("languageSelect").value;
        localStorage.setItem("language", selectedLanguage);
        alert(`Language changed to ${selectedLanguage}`);
        // Additional logic to update UI text based on the selected language can be added here
    }

    function toggleNotifications() {
        const isEnabled = document.getElementById("notificationsToggle").checked;
        localStorage.setItem("notificationsEnabled", isEnabled.toString());
        alert(isEnabled ? "Notifications enabled." : "Notifications disabled.");
    }

    function toggleSmsAlerts() {
        const isEnabled = document.getElementById("smsAlertToggle").checked;
        localStorage.setItem("smsAlertsEnabled", isEnabled.toString());
        alert(isEnabled ? "SMS Alerts enabled for favorite routes." : "SMS Alerts disabled.");
    }

    function toggleVoiceAnnouncements() {
        const isEnabled = document.getElementById("voiceToggle").checked;
        localStorage.setItem("voiceAnnouncements", isEnabled.toString());
        alert(isEnabled ? "Voice Announcements enabled." : "Voice Announcements disabled.");
    }

    function toggleAutoRefresh() {
        const isEnabled = document.getElementById("autoRefreshToggle").checked;
        localStorage.setItem("autoRefresh", isEnabled.toString());
        alert(isEnabled ? "Auto-Refresh for bus data enabled." : "Auto-Refresh for bus data disabled.");
    }

    function toggleLocationTracking() {
        const isEnabled = document.getElementById("locationTrackingToggle").checked;
        localStorage.setItem("locationTrackingEnabled", isEnabled.toString());
        alert(isEnabled ? "Location Tracking enabled." : "Location Tracking disabled.");
        if (isEnabled) {
            trackLocation();
        }
    }

    function resetSettings() {
        document.getElementById("darkModeToggle").checked = false;
        document.getElementById("voiceToggle").checked = false;
        document.getElementById("notificationsToggle").checked = false;
        document.getElementById("smsAlertToggle").checked = false;
        document.getElementById("autoRefreshToggle").checked = false;
        document.getElementById("locationTrackingToggle").checked = false;
        document.getElementById("languageSelect").value = "en";

        localStorage.removeItem("darkMode");
        localStorage.removeItem("voiceAnnouncements");
        localStorage.removeItem("notificationsEnabled");
        localStorage.removeItem("smsAlertsEnabled");
        localStorage.removeItem("autoRefresh");
        localStorage.removeItem("locationTrackingEnabled");
        localStorage.removeItem("language");

        alert("Settings have been reset to default.");
    }
</script>

</body>
</html>
